<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Xiaochuan&#39;s blog</title>
<link>https://xiaochuany.github.io/1principle/</link>
<atom:link href="https://xiaochuany.github.io/1principle/index.xml" rel="self" type="application/rss+xml"/>
<description>Xiaochuan&#39;s blog: first principles first</description>
<generator>quarto-1.5.57</generator>
<lastBuildDate>Tue, 15 Oct 2024 00:00:00 GMT</lastBuildDate>
<item>
  <title>Financial time series: a journey from code to maths, and back</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/202410/tscm.html</link>
  <description><![CDATA[ 





<p>In this post we discuss a fundamental model in financial time series modelling - the ARCH model.</p>
<p>The model was introduced by Engle in the 80â€™s and brought him a Nobel prize in Economy. Nowadays ARCH is still the go-to model, or at least a starting point for time series with varying volatility, a characteristic shared by many financial return series.</p>
<section id="arch-model" class="level2">
<h2 class="anchored" data-anchor-id="arch-model">ARCH model</h2>
<p>Throughout we always denote a time series by <img src="https://latex.codecogs.com/png.latex?(Y_t)">. ARCH model is a specification of the conditional variance of <img src="https://latex.codecogs.com/png.latex?Y_t"> given its history <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%20F_%7Bt-1%7D"> by the following equation: <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BVar%7D%5BY_t%7C%20%5Cmathcal%20F_%7Bt-1%7D%5D%20=%20%5Comega%20+%20%5Calpha%20Y_%7Bt-1%7D%5E2."></p>
<p>In python, it is straightforward to define the ARCH model with the <code>arch</code> library.</p>
</section>
<section id="arch-library" class="level2">
<h2 class="anchored" data-anchor-id="arch-library"><code>arch</code> library</h2>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> arch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> arch_model</span></code></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41</span>)</span>
<span id="cb2-2">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.standard_normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>,)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb2-3">mod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arch_model(y, mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zero'</span>, q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-4">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mod.fit(disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb2-5">fcst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.forecast(horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bootstrap"</span>, simulations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</div>
<p>Above we exposed the main classes of the library.<br>
- <code>arch_model</code> is a convenience model constructor function with which one can specify the the mean process, the volatility (aka conditional standard deviation), the noise distribution (adhering to <code>scipy.stats</code>).<br>
- <code>mod.fit()</code> returns a result container: one that contains residuals, standardised residuals, conditional volatility of the fit model.<br>
- <code>res.forecast()</code> returns a forecast container: one that contains conditonal variance given the present value, simulations given the current value etc.</p>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(mod), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(res), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(fcst)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(arch.univariate.mean.ZeroMean,
 arch.univariate.base.ARCHModelResult,
 arch.univariate.base.ARCHModelForecast)</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">res.summary()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Zero Mean - ARCH Model Results</caption>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Dep. Variable:</td>
<td>y</td>
<td data-quarto-table-cell-role="th">R-squared:</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Mean Model:</td>
<td>Zero Mean</td>
<td data-quarto-table-cell-role="th">Adj. R-squared:</td>
<td>0.002</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Vol Model:</td>
<td>ARCH</td>
<td data-quarto-table-cell-role="th">Log-Likelihood:</td>
<td>-2719.79</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Distribution:</td>
<td>Normal</td>
<td data-quarto-table-cell-role="th">AIC:</td>
<td>5443.58</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Method:</td>
<td>Maximum Likelihood</td>
<td data-quarto-table-cell-role="th">BIC:</td>
<td>5452.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th"></td>
<td></td>
<td data-quarto-table-cell-role="th">No. Observations:</td>
<td>500</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Date:</td>
<td>Sat, Oct 19 2024</td>
<td data-quarto-table-cell-role="th">Df Residuals:</td>
<td>500</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Time:</td>
<td>18:28:40</td>
<td data-quarto-table-cell-role="th">Df Model:</td>
<td>0</td>
</tr>
</tbody>
</table>


<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Volatility Model</caption>
<tbody>
<tr class="odd">
<td></td>
<td data-quarto-table-cell-role="th">coef</td>
<td data-quarto-table-cell-role="th">std err</td>
<td data-quarto-table-cell-role="th">t</td>
<td data-quarto-table-cell-role="th">P&gt;|t|</td>
<td data-quarto-table-cell-role="th">95.0% Conf. Int.</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">omega</td>
<td>2082.8286</td>
<td>396.923</td>
<td>5.247</td>
<td>1.542e-07</td>
<td>[1.305e+03,2.861e+03]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">alpha[1]</td>
<td>0.4962</td>
<td>0.174</td>
<td>2.850</td>
<td>4.377e-03</td>
<td>[ 0.155, 0.838]</td>
</tr>
</tbody>
</table>
<br><br>Covariance estimator: robust
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> hvplot.polars</span>
<span id="cb6-3">hvplot.extension(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matplotlib'</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5">pl.DataFrame(fcst.simulations.values.squeeze().T).hvplot() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3 forecasted paths with horizon 50</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="esms-options">{"shimMode": true}</script><style>*[data-root-id],
*[data-root-id] > * {
  box-sizing: border-box;
  font-family: var(--jp-ui-font-family);
  font-size: var(--jp-ui-font-size1);
  color: var(--vscode-editor-foreground, var(--jp-ui-font-color1));
}

/* Override VSCode background color */
.cell-output-ipywidget-background:has(
    > .cell-output-ipywidget-background > .lm-Widget > *[data-root-id]
  ),
.cell-output-ipywidget-background:has(> .lm-Widget > *[data-root-id]) {
  background-color: transparent !important;
}
</style>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">
(function(root) {
  function now() {
    return new Date();
  }

  const force = true;
  const py_version = '3.6.0'.replace('rc', '-rc.').replace('.dev', '-dev.');
  const reloading = false;
  const Bokeh = root.Bokeh;

  // Set a timeout for this load but only if we are not already initializing
  if (typeof (root._bokeh_timeout) === "undefined" || (force || !root._bokeh_is_initializing)) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks;
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, js_modules, js_exports, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];
    if (js_modules == null) js_modules = [];
    if (js_exports == null) js_exports = {};

    root._bokeh_onload_callbacks.push(callback);

    if (root._bokeh_is_loading > 0) {
      // Don't load bokeh if it is still initializing
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    } else if (js_urls.length === 0 && js_modules.length === 0 && Object.keys(js_exports).length === 0) {
      // There is nothing to load
      run_callbacks();
      return null;
    }

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }
    window._bokeh_on_load = on_load

    function on_error(e) {
      const src_el = e.srcElement
      console.error("failed to load " + (src_el.href || src_el.src));
    }

    const skip = [];
    if (window.requirejs) {
      window.requirejs.config({'packages': {}, 'paths': {}, 'shim': {}});
      root._bokeh_is_loading = css_urls.length + 0;
    } else {
      root._bokeh_is_loading = css_urls.length + js_urls.length + js_modules.length + Object.keys(js_exports).length;
    }

    const existing_stylesheets = []
    const links = document.getElementsByTagName('link')
    for (let i = 0; i < links.length; i++) {
      const link = links[i]
      if (link.href != null) {
        existing_stylesheets.push(link.href)
      }
    }
    for (let i = 0; i < css_urls.length; i++) {
      const url = css_urls[i];
      const escaped = encodeURI(url)
      if (existing_stylesheets.indexOf(escaped) !== -1) {
        on_load()
        continue;
      }
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error;
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }    var existing_scripts = []
    const scripts = document.getElementsByTagName('script')
    for (let i = 0; i < scripts.length; i++) {
      var script = scripts[i]
      if (script.src != null) {
        existing_scripts.push(script.src)
      }
    }
    for (let i = 0; i < js_urls.length; i++) {
      const url = js_urls[i];
      const escaped = encodeURI(url)
      if (skip.indexOf(escaped) !== -1 || existing_scripts.indexOf(escaped) !== -1) {
        if (!window.requirejs) {
          on_load();
        }
        continue;
      }
      const element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
    for (let i = 0; i < js_modules.length; i++) {
      const url = js_modules[i];
      const escaped = encodeURI(url)
      if (skip.indexOf(escaped) !== -1 || existing_scripts.indexOf(escaped) !== -1) {
        if (!window.requirejs) {
          on_load();
        }
        continue;
      }
      var element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      element.type = "module";
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
    for (const name in js_exports) {
      const url = js_exports[name];
      const escaped = encodeURI(url)
      if (skip.indexOf(escaped) >= 0 || root[name] != null) {
        if (!window.requirejs) {
          on_load();
        }
        continue;
      }
      var element = document.createElement('script');
      element.onerror = on_error;
      element.async = false;
      element.type = "module";
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      element.textContent = `
      import ${name} from "${url}"
      window.${name} = ${name}
      window._bokeh_on_load()
      `
      document.head.appendChild(element);
    }
    if (!js_urls.length && !js_modules.length) {
      on_load()
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  const js_urls = ["https://cdn.holoviz.org/panel/1.5.2/dist/bundled/reactiveesm/es-module-shims@^1.10.0/dist/es-module-shims.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.6.0.min.js", "https://cdn.holoviz.org/panel/1.5.2/dist/panel.min.js"];
  const js_modules = [];
  const js_exports = {};
  const css_urls = [];
  const inline_js = [    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
function(Bokeh) {} // ensure no trailing comma for IE
  ];

  function run_inline_js() {
    if ((root.Bokeh !== undefined) || (force === true)) {
      for (let i = 0; i < inline_js.length; i++) {
        try {
          inline_js[i].call(root, root.Bokeh);
        } catch(e) {
          if (!reloading) {
            throw e;
          }
        }
      }
      // Cache old bokeh versions
      if (Bokeh != undefined && !reloading) {
        var NewBokeh = root.Bokeh;
        if (Bokeh.versions === undefined) {
          Bokeh.versions = new Map();
        }
        if (NewBokeh.version !== Bokeh.version) {
          Bokeh.versions.set(NewBokeh.version, NewBokeh)
        }
        root.Bokeh = Bokeh;
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    }
    root._bokeh_is_initializing = false
  }

  function load_or_wait() {
    // Implement a backoff loop that tries to ensure we do not load multiple
    // versions of Bokeh and its dependencies at the same time.
    // In recent versions we use the root._bokeh_is_initializing flag
    // to determine whether there is an ongoing attempt to initialize
    // bokeh, however for backward compatibility we also try to ensure
    // that we do not start loading a newer (Panel>=1.0 and Bokeh>3) version
    // before older versions are fully initialized.
    if (root._bokeh_is_initializing && Date.now() > root._bokeh_timeout) {
      // If the timeout and bokeh was not successfully loaded we reset
      // everything and try loading again
      root._bokeh_timeout = Date.now() + 5000;
      root._bokeh_is_initializing = false;
      root._bokeh_onload_callbacks = undefined;
      root._bokeh_is_loading = 0
      console.log("Bokeh: BokehJS was loaded multiple times but one version failed to initialize.");
      load_or_wait();
    } else if (root._bokeh_is_initializing || (typeof root._bokeh_is_initializing === "undefined" && root._bokeh_onload_callbacks !== undefined)) {
      setTimeout(load_or_wait, 100);
    } else {
      root._bokeh_is_initializing = true
      root._bokeh_onload_callbacks = []
      const bokeh_loaded = root.Bokeh != null && (root.Bokeh.version === py_version || (root.Bokeh.versions !== undefined && root.Bokeh.versions.has(py_version)));
      if (!reloading && !bokeh_loaded) {
        if (root.Bokeh) {
          root.Bokeh = undefined;
        }
        console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
      }
      load_libs(css_urls, js_urls, js_modules, js_exports, function() {
        console.debug("Bokeh: BokehJS plotting callback run at", now());
        run_inline_js();
      });
    }
  }
  // Give older versions of the autoload script a head-start to ensure
  // they initialize before we start loading newer version.
  setTimeout(load_or_wait, 100)
}(window));
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">

if ((window.PyViz === undefined) || (window.PyViz instanceof HTMLElement)) {
  window.PyViz = {comms: {}, comm_status:{}, kernels:{}, receivers: {}, plot_index: []}
}


    function JupyterCommManager() {
    }

    JupyterCommManager.prototype.register_target = function(plot_id, comm_id, msg_handler) {
      if (window.comm_manager || ((window.Jupyter !== undefined) && (Jupyter.notebook.kernel != null))) {
        var comm_manager = window.comm_manager || Jupyter.notebook.kernel.comm_manager;
        comm_manager.register_target(comm_id, function(comm) {
          comm.on_msg(msg_handler);
        });
      } else if ((plot_id in window.PyViz.kernels) && (window.PyViz.kernels[plot_id])) {
        window.PyViz.kernels[plot_id].registerCommTarget(comm_id, function(comm) {
          comm.onMsg = msg_handler;
        });
      } else if (typeof google != 'undefined' && google.colab.kernel != null) {
        google.colab.kernel.comms.registerTarget(comm_id, (comm) => {
          var messages = comm.messages[Symbol.asyncIterator]();
          function processIteratorResult(result) {
            var message = result.value;
            console.log(message)
            var content = {data: message.data, comm_id};
            var buffers = []
            for (var buffer of message.buffers || []) {
              buffers.push(new DataView(buffer))
            }
            var metadata = message.metadata || {};
            var msg = {content, buffers, metadata}
            msg_handler(msg);
            return messages.next().then(processIteratorResult);
          }
          return messages.next().then(processIteratorResult);
        })
      }
    }

    JupyterCommManager.prototype.get_client_comm = function(plot_id, comm_id, msg_handler) {
      if (comm_id in window.PyViz.comms) {
        return window.PyViz.comms[comm_id];
      } else if (window.comm_manager || ((window.Jupyter !== undefined) && (Jupyter.notebook.kernel != null))) {
        var comm_manager = window.comm_manager || Jupyter.notebook.kernel.comm_manager;
        var comm = comm_manager.new_comm(comm_id, {}, {}, {}, comm_id);
        if (msg_handler) {
          comm.on_msg(msg_handler);
        }
      } else if ((plot_id in window.PyViz.kernels) && (window.PyViz.kernels[plot_id])) {
        var comm = window.PyViz.kernels[plot_id].connectToComm(comm_id);
        comm.open();
        if (msg_handler) {
          comm.onMsg = msg_handler;
        }
      } else if (typeof google != 'undefined' && google.colab.kernel != null) {
        var comm_promise = google.colab.kernel.comms.open(comm_id)
        comm_promise.then((comm) => {
          window.PyViz.comms[comm_id] = comm;
          if (msg_handler) {
            var messages = comm.messages[Symbol.asyncIterator]();
            function processIteratorResult(result) {
              var message = result.value;
              var content = {data: message.data};
              var metadata = message.metadata || {comm_id};
              var msg = {content, metadata}
              msg_handler(msg);
              return messages.next().then(processIteratorResult);
            }
            return messages.next().then(processIteratorResult);
          }
        }) 
        var sendClosure = (data, metadata, buffers, disposeOnDone) => {
          return comm_promise.then((comm) => {
            comm.send(data, metadata, buffers, disposeOnDone);
          });
        };
        var comm = {
          send: sendClosure
        };
      }
      window.PyViz.comms[comm_id] = comm;
      return comm;
    }
    window.PyViz.comm_manager = new JupyterCommManager();
    


var JS_MIME_TYPE = 'application/javascript';
var HTML_MIME_TYPE = 'text/html';
var EXEC_MIME_TYPE = 'application/vnd.holoviews_exec.v0+json';
var CLASS_NAME = 'output';

/**
 * Render data to the DOM node
 */
function render(props, node) {
  var div = document.createElement("div");
  var script = document.createElement("script");
  node.appendChild(div);
  node.appendChild(script);
}

/**
 * Handle when a new output is added
 */
function handle_add_output(event, handle) {
  var output_area = handle.output_area;
  var output = handle.output;
  if ((output.data == undefined) || (!output.data.hasOwnProperty(EXEC_MIME_TYPE))) {
    return
  }
  var id = output.metadata[EXEC_MIME_TYPE]["id"];
  var toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);
  if (id !== undefined) {
    var nchildren = toinsert.length;
    var html_node = toinsert[nchildren-1].children[0];
    html_node.innerHTML = output.data[HTML_MIME_TYPE];
    var scripts = [];
    var nodelist = html_node.querySelectorAll("script");
    for (var i in nodelist) {
      if (nodelist.hasOwnProperty(i)) {
        scripts.push(nodelist[i])
      }
    }

    scripts.forEach( function (oldScript) {
      var newScript = document.createElement("script");
      var attrs = [];
      var nodemap = oldScript.attributes;
      for (var j in nodemap) {
        if (nodemap.hasOwnProperty(j)) {
          attrs.push(nodemap[j])
        }
      }
      attrs.forEach(function(attr) { newScript.setAttribute(attr.name, attr.value) });
      newScript.appendChild(document.createTextNode(oldScript.innerHTML));
      oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    if (JS_MIME_TYPE in output.data) {
      toinsert[nchildren-1].children[1].textContent = output.data[JS_MIME_TYPE];
    }
    output_area._hv_plot_id = id;
    if ((window.Bokeh !== undefined) && (id in Bokeh.index)) {
      window.PyViz.plot_index[id] = Bokeh.index[id];
    } else {
      window.PyViz.plot_index[id] = null;
    }
  } else if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
    var bk_div = document.createElement("div");
    bk_div.innerHTML = output.data[HTML_MIME_TYPE];
    var script_attrs = bk_div.children[0].attributes;
    for (var i = 0; i < script_attrs.length; i++) {
      toinsert[toinsert.length - 1].childNodes[1].setAttribute(script_attrs[i].name, script_attrs[i].value);
    }
    // store reference to server id on output_area
    output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
  }
}

/**
 * Handle when an output is cleared or removed
 */
function handle_clear_output(event, handle) {
  var id = handle.cell.output_area._hv_plot_id;
  var server_id = handle.cell.output_area._bokeh_server_id;
  if (((id === undefined) || !(id in PyViz.plot_index)) && (server_id !== undefined)) { return; }
  var comm = window.PyViz.comm_manager.get_client_comm("hv-extension-comm", "hv-extension-comm", function () {});
  if (server_id !== null) {
    comm.send({event_type: 'server_delete', 'id': server_id});
    return;
  } else if (comm !== null) {
    comm.send({event_type: 'delete', 'id': id});
  }
  delete PyViz.plot_index[id];
  if ((window.Bokeh !== undefined) & (id in window.Bokeh.index)) {
    var doc = window.Bokeh.index[id].model.document
    doc.clear();
    const i = window.Bokeh.documents.indexOf(doc);
    if (i > -1) {
      window.Bokeh.documents.splice(i, 1);
    }
  }
}

/**
 * Handle kernel restart event
 */
function handle_kernel_cleanup(event, handle) {
  delete PyViz.comms["hv-extension-comm"];
  window.PyViz.plot_index = {}
}

/**
 * Handle update_display_data messages
 */
function handle_update_output(event, handle) {
  handle_clear_output(event, {cell: {output_area: handle.output_area}})
  handle_add_output(event, handle)
}

function register_renderer(events, OutputArea) {
  function append_mime(data, metadata, element) {
    // create a DOM node to render to
    var toinsert = this.create_output_subarea(
    metadata,
    CLASS_NAME,
    EXEC_MIME_TYPE
    );
    this.keyboard_manager.register_events(toinsert);
    // Render to node
    var props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
    render(props, toinsert[0]);
    element.append(toinsert);
    return toinsert
  }

  events.on('output_added.OutputArea', handle_add_output);
  events.on('output_updated.OutputArea', handle_update_output);
  events.on('clear_output.CodeCell', handle_clear_output);
  events.on('delete.Cell', handle_clear_output);
  events.on('kernel_ready.Kernel', handle_kernel_cleanup);

  OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
    safe: true,
    index: 0
  });
}

if (window.Jupyter !== undefined) {
  try {
    var events = require('base/js/events');
    var OutputArea = require('notebook/js/outputarea').OutputArea;
    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  } catch(err) {
  }
}

</script>
</div>
<div class="cell-output cell-output-display">
<div id="p1002">
  <div id="f2933001-744e-4c0d-a024-ee95da3e3209" data-root-id="p1002" style="display: contents;"></div>
</div>
<script type="application/javascript">(function(root) {
  var docs_json = {"1d19c79f-b249-4239-8dbe-f67eefa6bef7":{"version":"3.6.0","title":"Bokeh Application","roots":[{"type":"object","name":"panel.models.browser.BrowserInfo","id":"p1002"},{"type":"object","name":"panel.models.comm_manager.CommManager","id":"p1003","attributes":{"plot_id":"p1002","comm_id":"97133af19fea4cca828ae8bed905c5c4","client_comm_id":"ad9d2beb6bb94358b064902e2379ad34"}}],"defs":[{"type":"model","name":"ReactiveHTML1"},{"type":"model","name":"FlexBox1","properties":[{"name":"align_content","kind":"Any","default":"flex-start"},{"name":"align_items","kind":"Any","default":"flex-start"},{"name":"flex_direction","kind":"Any","default":"row"},{"name":"flex_wrap","kind":"Any","default":"wrap"},{"name":"gap","kind":"Any","default":""},{"name":"justify_content","kind":"Any","default":"flex-start"}]},{"type":"model","name":"FloatPanel1","properties":[{"name":"config","kind":"Any","default":{"type":"map"}},{"name":"contained","kind":"Any","default":true},{"name":"position","kind":"Any","default":"right-top"},{"name":"offsetx","kind":"Any","default":null},{"name":"offsety","kind":"Any","default":null},{"name":"theme","kind":"Any","default":"primary"},{"name":"status","kind":"Any","default":"normalized"}]},{"type":"model","name":"GridStack1","properties":[{"name":"mode","kind":"Any","default":"warn"},{"name":"ncols","kind":"Any","default":null},{"name":"nrows","kind":"Any","default":null},{"name":"allow_resize","kind":"Any","default":true},{"name":"allow_drag","kind":"Any","default":true},{"name":"state","kind":"Any","default":[]}]},{"type":"model","name":"drag1","properties":[{"name":"slider_width","kind":"Any","default":5},{"name":"slider_color","kind":"Any","default":"black"},{"name":"value","kind":"Any","default":50}]},{"type":"model","name":"click1","properties":[{"name":"terminal_output","kind":"Any","default":""},{"name":"debug_name","kind":"Any","default":""},{"name":"clears","kind":"Any","default":0}]},{"type":"model","name":"FastWrapper1","properties":[{"name":"object","kind":"Any","default":null},{"name":"style","kind":"Any","default":null}]},{"type":"model","name":"NotificationAreaBase1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0}]},{"type":"model","name":"NotificationArea1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"notifications","kind":"Any","default":[]},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0},{"name":"types","kind":"Any","default":[{"type":"map","entries":[["type","warning"],["background","#ffc107"],["icon",{"type":"map","entries":[["className","fas fa-exclamation-triangle"],["tagName","i"],["color","white"]]}]]},{"type":"map","entries":[["type","info"],["background","#007bff"],["icon",{"type":"map","entries":[["className","fas fa-info-circle"],["tagName","i"],["color","white"]]}]]}]}]},{"type":"model","name":"Notification","properties":[{"name":"background","kind":"Any","default":null},{"name":"duration","kind":"Any","default":3000},{"name":"icon","kind":"Any","default":null},{"name":"message","kind":"Any","default":""},{"name":"notification_type","kind":"Any","default":null},{"name":"_destroyed","kind":"Any","default":false}]},{"type":"model","name":"TemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"BootstrapTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"TemplateEditor1","properties":[{"name":"layout","kind":"Any","default":[]}]},{"type":"model","name":"MaterialTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"ReactiveESM1"},{"type":"model","name":"JSComponent1"},{"type":"model","name":"ReactComponent1"},{"type":"model","name":"AnyWidgetComponent1"},{"type":"model","name":"request_value1","properties":[{"name":"fill","kind":"Any","default":"none"},{"name":"_synced","kind":"Any","default":null},{"name":"_request_sync","kind":"Any","default":0}]}]}};
  var render_items = [{"docid":"1d19c79f-b249-4239-8dbe-f67eefa6bef7","roots":{"p1002":"f2933001-744e-4c0d-a024-ee95da3e3209"},"root_ids":["p1002"]}];
  var docs = Object.values(docs_json)
  if (!docs) {
    return
  }
  const py_version = docs[0].version.replace('rc', '-rc.').replace('.dev', '-dev.')
  async function embed_document(root) {
    var Bokeh = get_bokeh(root)
    await Bokeh.embed.embed_items_notebook(docs_json, render_items);
    for (const render_item of render_items) {
      for (const root_id of render_item.root_ids) {
    const id_el = document.getElementById(root_id)
    if (id_el.children.length && id_el.children[0].hasAttribute('data-root-id')) {
      const root_el = id_el.children[0]
      root_el.id = root_el.id + '-rendered'
      for (const child of root_el.children) {
            // Ensure JupyterLab does not capture keyboard shortcuts
            // see: https://jupyterlab.readthedocs.io/en/4.1.x/extension/notebook.html#keyboard-interaction-model
        child.setAttribute('data-lm-suppress-shortcuts', 'true')
      }
    }
      }
    }
  }
  function get_bokeh(root) {
    if (root.Bokeh === undefined) {
      return null
    } else if (root.Bokeh.version !== py_version) {
      if (root.Bokeh.versions === undefined || !root.Bokeh.versions.has(py_version)) {
    return null
      }
      return root.Bokeh.versions.get(py_version);
    } else if (root.Bokeh.version === py_version) {
      return root.Bokeh
    }
    return null
  }
  function is_loaded(root) {
    var Bokeh = get_bokeh(root)
    return (Bokeh != null && Bokeh.Panel !== undefined)
  }
  if (is_loaded(root)) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (is_loaded(root)) {
        clearInterval(timer);
        embed_document(root);
      } else if (document.readyState == "complete") {
        attempts++;
        if (attempts > 200) {
          clearInterval(timer);
      var Bokeh = get_bokeh(root)
      if (Bokeh == null || Bokeh.Panel == null) {
            console.warn("Panel: ERROR: Unable to run Panel code because Bokeh or Panel library is missing");
      } else {
        console.warn("Panel: WARNING: Attempting to render but not all required libraries could be resolved.")
        embed_document(root)
      }
        }
      }
    }, 25, root)
  }
})(window);</script>
</div>
<div class="cell-output cell-output-display">
<script type="esms-options">{"shimMode": true}</script><style>*[data-root-id],
*[data-root-id] > * {
  box-sizing: border-box;
  font-family: var(--jp-ui-font-family);
  font-size: var(--jp-ui-font-size1);
  color: var(--vscode-editor-foreground, var(--jp-ui-font-color1));
}

/* Override VSCode background color */
.cell-output-ipywidget-background:has(
    > .cell-output-ipywidget-background > .lm-Widget > *[data-root-id]
  ),
.cell-output-ipywidget-background:has(> .lm-Widget > *[data-root-id]) {
  background-color: transparent !important;
}
</style>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">
(function(root) {
  function now() {
    return new Date();
  }

  const force = false;
  const py_version = '3.6.0'.replace('rc', '-rc.').replace('.dev', '-dev.');
  const reloading = true;
  const Bokeh = root.Bokeh;

  // Set a timeout for this load but only if we are not already initializing
  if (typeof (root._bokeh_timeout) === "undefined" || (force || !root._bokeh_is_initializing)) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks;
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, js_modules, js_exports, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];
    if (js_modules == null) js_modules = [];
    if (js_exports == null) js_exports = {};

    root._bokeh_onload_callbacks.push(callback);

    if (root._bokeh_is_loading > 0) {
      // Don't load bokeh if it is still initializing
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    } else if (js_urls.length === 0 && js_modules.length === 0 && Object.keys(js_exports).length === 0) {
      // There is nothing to load
      run_callbacks();
      return null;
    }

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }
    window._bokeh_on_load = on_load

    function on_error(e) {
      const src_el = e.srcElement
      console.error("failed to load " + (src_el.href || src_el.src));
    }

    const skip = [];
    if (window.requirejs) {
      window.requirejs.config({'packages': {}, 'paths': {}, 'shim': {}});
      root._bokeh_is_loading = css_urls.length + 0;
    } else {
      root._bokeh_is_loading = css_urls.length + js_urls.length + js_modules.length + Object.keys(js_exports).length;
    }

    const existing_stylesheets = []
    const links = document.getElementsByTagName('link')
    for (let i = 0; i < links.length; i++) {
      const link = links[i]
      if (link.href != null) {
        existing_stylesheets.push(link.href)
      }
    }
    for (let i = 0; i < css_urls.length; i++) {
      const url = css_urls[i];
      const escaped = encodeURI(url)
      if (existing_stylesheets.indexOf(escaped) !== -1) {
        on_load()
        continue;
      }
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error;
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }    var existing_scripts = []
    const scripts = document.getElementsByTagName('script')
    for (let i = 0; i < scripts.length; i++) {
      var script = scripts[i]
      if (script.src != null) {
        existing_scripts.push(script.src)
      }
    }
    for (let i = 0; i < js_urls.length; i++) {
      const url = js_urls[i];
      const escaped = encodeURI(url)
      if (skip.indexOf(escaped) !== -1 || existing_scripts.indexOf(escaped) !== -1) {
        if (!window.requirejs) {
          on_load();
        }
        continue;
      }
      const element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
    for (let i = 0; i < js_modules.length; i++) {
      const url = js_modules[i];
      const escaped = encodeURI(url)
      if (skip.indexOf(escaped) !== -1 || existing_scripts.indexOf(escaped) !== -1) {
        if (!window.requirejs) {
          on_load();
        }
        continue;
      }
      var element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      element.type = "module";
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
    for (const name in js_exports) {
      const url = js_exports[name];
      const escaped = encodeURI(url)
      if (skip.indexOf(escaped) >= 0 || root[name] != null) {
        if (!window.requirejs) {
          on_load();
        }
        continue;
      }
      var element = document.createElement('script');
      element.onerror = on_error;
      element.async = false;
      element.type = "module";
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      element.textContent = `
      import ${name} from "${url}"
      window.${name} = ${name}
      window._bokeh_on_load()
      `
      document.head.appendChild(element);
    }
    if (!js_urls.length && !js_modules.length) {
      on_load()
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  const js_urls = ["https://cdn.holoviz.org/panel/1.5.2/dist/bundled/reactiveesm/es-module-shims@^1.10.0/dist/es-module-shims.min.js"];
  const js_modules = [];
  const js_exports = {};
  const css_urls = [];
  const inline_js = [    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
function(Bokeh) {} // ensure no trailing comma for IE
  ];

  function run_inline_js() {
    if ((root.Bokeh !== undefined) || (force === true)) {
      for (let i = 0; i < inline_js.length; i++) {
        try {
          inline_js[i].call(root, root.Bokeh);
        } catch(e) {
          if (!reloading) {
            throw e;
          }
        }
      }
      // Cache old bokeh versions
      if (Bokeh != undefined && !reloading) {
        var NewBokeh = root.Bokeh;
        if (Bokeh.versions === undefined) {
          Bokeh.versions = new Map();
        }
        if (NewBokeh.version !== Bokeh.version) {
          Bokeh.versions.set(NewBokeh.version, NewBokeh)
        }
        root.Bokeh = Bokeh;
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    }
    root._bokeh_is_initializing = false
  }

  function load_or_wait() {
    // Implement a backoff loop that tries to ensure we do not load multiple
    // versions of Bokeh and its dependencies at the same time.
    // In recent versions we use the root._bokeh_is_initializing flag
    // to determine whether there is an ongoing attempt to initialize
    // bokeh, however for backward compatibility we also try to ensure
    // that we do not start loading a newer (Panel>=1.0 and Bokeh>3) version
    // before older versions are fully initialized.
    if (root._bokeh_is_initializing && Date.now() > root._bokeh_timeout) {
      // If the timeout and bokeh was not successfully loaded we reset
      // everything and try loading again
      root._bokeh_timeout = Date.now() + 5000;
      root._bokeh_is_initializing = false;
      root._bokeh_onload_callbacks = undefined;
      root._bokeh_is_loading = 0
      console.log("Bokeh: BokehJS was loaded multiple times but one version failed to initialize.");
      load_or_wait();
    } else if (root._bokeh_is_initializing || (typeof root._bokeh_is_initializing === "undefined" && root._bokeh_onload_callbacks !== undefined)) {
      setTimeout(load_or_wait, 100);
    } else {
      root._bokeh_is_initializing = true
      root._bokeh_onload_callbacks = []
      const bokeh_loaded = root.Bokeh != null && (root.Bokeh.version === py_version || (root.Bokeh.versions !== undefined && root.Bokeh.versions.has(py_version)));
      if (!reloading && !bokeh_loaded) {
        if (root.Bokeh) {
          root.Bokeh = undefined;
        }
        console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
      }
      load_libs(css_urls, js_urls, js_modules, js_exports, function() {
        console.debug("Bokeh: BokehJS plotting callback run at", now());
        run_inline_js();
      });
    }
  }
  // Give older versions of the autoload script a head-start to ensure
  // they initialize before we start loading newer version.
  setTimeout(load_or_wait, 100)
}(window));
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">

if ((window.PyViz === undefined) || (window.PyViz instanceof HTMLElement)) {
  window.PyViz = {comms: {}, comm_status:{}, kernels:{}, receivers: {}, plot_index: []}
}


    function JupyterCommManager() {
    }

    JupyterCommManager.prototype.register_target = function(plot_id, comm_id, msg_handler) {
      if (window.comm_manager || ((window.Jupyter !== undefined) && (Jupyter.notebook.kernel != null))) {
        var comm_manager = window.comm_manager || Jupyter.notebook.kernel.comm_manager;
        comm_manager.register_target(comm_id, function(comm) {
          comm.on_msg(msg_handler);
        });
      } else if ((plot_id in window.PyViz.kernels) && (window.PyViz.kernels[plot_id])) {
        window.PyViz.kernels[plot_id].registerCommTarget(comm_id, function(comm) {
          comm.onMsg = msg_handler;
        });
      } else if (typeof google != 'undefined' && google.colab.kernel != null) {
        google.colab.kernel.comms.registerTarget(comm_id, (comm) => {
          var messages = comm.messages[Symbol.asyncIterator]();
          function processIteratorResult(result) {
            var message = result.value;
            console.log(message)
            var content = {data: message.data, comm_id};
            var buffers = []
            for (var buffer of message.buffers || []) {
              buffers.push(new DataView(buffer))
            }
            var metadata = message.metadata || {};
            var msg = {content, buffers, metadata}
            msg_handler(msg);
            return messages.next().then(processIteratorResult);
          }
          return messages.next().then(processIteratorResult);
        })
      }
    }

    JupyterCommManager.prototype.get_client_comm = function(plot_id, comm_id, msg_handler) {
      if (comm_id in window.PyViz.comms) {
        return window.PyViz.comms[comm_id];
      } else if (window.comm_manager || ((window.Jupyter !== undefined) && (Jupyter.notebook.kernel != null))) {
        var comm_manager = window.comm_manager || Jupyter.notebook.kernel.comm_manager;
        var comm = comm_manager.new_comm(comm_id, {}, {}, {}, comm_id);
        if (msg_handler) {
          comm.on_msg(msg_handler);
        }
      } else if ((plot_id in window.PyViz.kernels) && (window.PyViz.kernels[plot_id])) {
        var comm = window.PyViz.kernels[plot_id].connectToComm(comm_id);
        comm.open();
        if (msg_handler) {
          comm.onMsg = msg_handler;
        }
      } else if (typeof google != 'undefined' && google.colab.kernel != null) {
        var comm_promise = google.colab.kernel.comms.open(comm_id)
        comm_promise.then((comm) => {
          window.PyViz.comms[comm_id] = comm;
          if (msg_handler) {
            var messages = comm.messages[Symbol.asyncIterator]();
            function processIteratorResult(result) {
              var message = result.value;
              var content = {data: message.data};
              var metadata = message.metadata || {comm_id};
              var msg = {content, metadata}
              msg_handler(msg);
              return messages.next().then(processIteratorResult);
            }
            return messages.next().then(processIteratorResult);
          }
        }) 
        var sendClosure = (data, metadata, buffers, disposeOnDone) => {
          return comm_promise.then((comm) => {
            comm.send(data, metadata, buffers, disposeOnDone);
          });
        };
        var comm = {
          send: sendClosure
        };
      }
      window.PyViz.comms[comm_id] = comm;
      return comm;
    }
    window.PyViz.comm_manager = new JupyterCommManager();
    


var JS_MIME_TYPE = 'application/javascript';
var HTML_MIME_TYPE = 'text/html';
var EXEC_MIME_TYPE = 'application/vnd.holoviews_exec.v0+json';
var CLASS_NAME = 'output';

/**
 * Render data to the DOM node
 */
function render(props, node) {
  var div = document.createElement("div");
  var script = document.createElement("script");
  node.appendChild(div);
  node.appendChild(script);
}

/**
 * Handle when a new output is added
 */
function handle_add_output(event, handle) {
  var output_area = handle.output_area;
  var output = handle.output;
  if ((output.data == undefined) || (!output.data.hasOwnProperty(EXEC_MIME_TYPE))) {
    return
  }
  var id = output.metadata[EXEC_MIME_TYPE]["id"];
  var toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);
  if (id !== undefined) {
    var nchildren = toinsert.length;
    var html_node = toinsert[nchildren-1].children[0];
    html_node.innerHTML = output.data[HTML_MIME_TYPE];
    var scripts = [];
    var nodelist = html_node.querySelectorAll("script");
    for (var i in nodelist) {
      if (nodelist.hasOwnProperty(i)) {
        scripts.push(nodelist[i])
      }
    }

    scripts.forEach( function (oldScript) {
      var newScript = document.createElement("script");
      var attrs = [];
      var nodemap = oldScript.attributes;
      for (var j in nodemap) {
        if (nodemap.hasOwnProperty(j)) {
          attrs.push(nodemap[j])
        }
      }
      attrs.forEach(function(attr) { newScript.setAttribute(attr.name, attr.value) });
      newScript.appendChild(document.createTextNode(oldScript.innerHTML));
      oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    if (JS_MIME_TYPE in output.data) {
      toinsert[nchildren-1].children[1].textContent = output.data[JS_MIME_TYPE];
    }
    output_area._hv_plot_id = id;
    if ((window.Bokeh !== undefined) && (id in Bokeh.index)) {
      window.PyViz.plot_index[id] = Bokeh.index[id];
    } else {
      window.PyViz.plot_index[id] = null;
    }
  } else if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
    var bk_div = document.createElement("div");
    bk_div.innerHTML = output.data[HTML_MIME_TYPE];
    var script_attrs = bk_div.children[0].attributes;
    for (var i = 0; i < script_attrs.length; i++) {
      toinsert[toinsert.length - 1].childNodes[1].setAttribute(script_attrs[i].name, script_attrs[i].value);
    }
    // store reference to server id on output_area
    output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
  }
}

/**
 * Handle when an output is cleared or removed
 */
function handle_clear_output(event, handle) {
  var id = handle.cell.output_area._hv_plot_id;
  var server_id = handle.cell.output_area._bokeh_server_id;
  if (((id === undefined) || !(id in PyViz.plot_index)) && (server_id !== undefined)) { return; }
  var comm = window.PyViz.comm_manager.get_client_comm("hv-extension-comm", "hv-extension-comm", function () {});
  if (server_id !== null) {
    comm.send({event_type: 'server_delete', 'id': server_id});
    return;
  } else if (comm !== null) {
    comm.send({event_type: 'delete', 'id': id});
  }
  delete PyViz.plot_index[id];
  if ((window.Bokeh !== undefined) & (id in window.Bokeh.index)) {
    var doc = window.Bokeh.index[id].model.document
    doc.clear();
    const i = window.Bokeh.documents.indexOf(doc);
    if (i > -1) {
      window.Bokeh.documents.splice(i, 1);
    }
  }
}

/**
 * Handle kernel restart event
 */
function handle_kernel_cleanup(event, handle) {
  delete PyViz.comms["hv-extension-comm"];
  window.PyViz.plot_index = {}
}

/**
 * Handle update_display_data messages
 */
function handle_update_output(event, handle) {
  handle_clear_output(event, {cell: {output_area: handle.output_area}})
  handle_add_output(event, handle)
}

function register_renderer(events, OutputArea) {
  function append_mime(data, metadata, element) {
    // create a DOM node to render to
    var toinsert = this.create_output_subarea(
    metadata,
    CLASS_NAME,
    EXEC_MIME_TYPE
    );
    this.keyboard_manager.register_events(toinsert);
    // Render to node
    var props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
    render(props, toinsert[0]);
    element.append(toinsert);
    return toinsert
  }

  events.on('output_added.OutputArea', handle_add_output);
  events.on('output_updated.OutputArea', handle_update_output);
  events.on('clear_output.CodeCell', handle_clear_output);
  events.on('delete.Cell', handle_clear_output);
  events.on('kernel_ready.Kernel', handle_kernel_cleanup);

  OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
    safe: true,
    index: 0
  });
}

if (window.Jupyter !== undefined) {
  try {
    var events = require('base/js/events');
    var OutputArea = require('notebook/js/outputarea').OutputArea;
    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  } catch(err) {
  }
}

</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<img src="https://xiaochuany.github.io/1principle/posts/202410/data:image/png;base64,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" style="max-width:100%; margin: auto; display: block; ">
</div>
</div>
<!-- ## Zooming in: the result summary

There are plenty of information in the summary. Most of them should be self-explanatory if one is familiar with basic terminology of statistical inference. Notice that the model we defind is `GARCH`, where "G" stands for "Generalised". A typical GARCH process is GARCH(1,1) defined through the specification: 
$$\mathrm{Var}[Y_t| \mathcal F_{t-1}] = \omega + \alpha Y_{t-1}^2 + \beta \mathrm{Var}[Y_{t-1}| \mathcal F_{t-2}].$$ -->
</section>
<section id="mean-model-and-noise-distribution" class="level2">
<h2 class="anchored" data-anchor-id="mean-model-and-noise-distribution">Mean model and noise distribution</h2>
<p>By default the noise distribution is standard normal. Another popular choice is t distribution where the degree of freedom <img src="https://latex.codecogs.com/png.latex?%5Cnu"> is a model parameter.<br>
One can also change the mean to be non-zero. The model spec is as follows <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AY_t%20&amp;=%20%5Cmu%20+%20%5Csigma_t%20W_t%20%5C%5C%20%20%0A%5Csigma_t%5E2%20&amp;=%20%5Comega+%20%5Calpha%20(Y_%7Bt-1%7D-%5Cmu)%5E2%0A%5Cend%7Balign*%7D%0A"> where <img src="https://latex.codecogs.com/png.latex?W_t"> is iid with t distribution, say.</p>
<p>In <code>arch</code>, it suffices to set <code>mean="constant"</code> and <code>dist="t"</code> in the constructor.</p>
<div id="cell-12" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">arch_model(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constant"</span>, q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'t'</span>).fit(disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>                         Constant Mean - ARCH Model Results                         
====================================================================================
Dep. Variable:                            y   R-squared:                       0.000
Mean Model:                   Constant Mean   Adj. R-squared:                  0.000
Vol Model:                             ARCH   Log-Likelihood:               -2679.58
Distribution:      Standardized Student's t   AIC:                           5367.17
Method:                  Maximum Likelihood   BIC:                           5384.03
                                              No. Observations:                  500
Date:                      Sat, Oct 19 2024   Df Residuals:                      499
Time:                              18:28:43   Df Model:                            1
                               Mean Model                               
========================================================================
                 coef    std err          t      P&gt;|t|  95.0% Conf. Int.
------------------------------------------------------------------------
mu            27.9482      1.487     18.797  7.917e-79 [ 25.034, 30.862]
                              Volatility Model                              
============================================================================
                 coef    std err          t      P&gt;|t|      95.0% Conf. Int.
----------------------------------------------------------------------------
omega       1557.7431    401.680      3.878  1.053e-04 [7.705e+02,2.345e+03]
alpha[1]       1.0000      0.263      3.798  1.460e-04     [  0.484,  1.516]
                              Distribution                              
========================================================================
                 coef    std err          t      P&gt;|t|  95.0% Conf. Int.
------------------------------------------------------------------------
nu             3.3891      0.357      9.480  2.536e-21 [  2.688,  4.090]
========================================================================

Covariance estimator: robust
ARCHModelResult, id: 0x7978505fd3a0</code></pre>
</div>
</div>
<p>Why stop here? We can also allow the conditonal mean of <img src="https://latex.codecogs.com/png.latex?Y_t"> given history to vary with time as well, one simplest choice would be to assume AR dynamic for the conditional mean <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AY_t%20&amp;=%20%5Cmu%20+%20%5Cphi%20(Y_%7Bt-1%7D%20-%20%5Cmu)%20+%20%5Csigma_t%20W_t%20%5C%5C%20%20%0A%5Csigma_t%5E2%20&amp;=%20%5Comega+%20%5Calpha%20(Y_%7Bt-1%7D-%5Cmu)%5E2%0A%5Cend%7Balign*%7D%0A"> where as before <img src="https://latex.codecogs.com/png.latex?W_t"> is iid normal by default.</p>
<p>In <code>arch</code>, just set <code>mean="AR"</code> and <code>lags=[1]</code> where 1 is as in AR(1) for the conditional mean.</p>
<div id="cell-14" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">arch_model(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AR"</span>, q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, lags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]).fit(disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>                           AR - ARCH Model Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                      -0.009
Mean Model:                        AR   Adj. R-squared:                 -0.011
Vol Model:                       ARCH   Log-Likelihood:               -2713.60
Distribution:                  Normal   AIC:                           5435.21
Method:            Maximum Likelihood   BIC:                           5452.06
                                        No. Observations:                  499
Date:                Sat, Oct 19 2024   Df Residuals:                      497
Time:                        18:28:43   Df Model:                            2
                               Mean Model                               
========================================================================
                 coef    std err          t      P&gt;|t|  95.0% Conf. Int.
------------------------------------------------------------------------
Const         27.0714      2.670     10.138  3.746e-24 [ 21.838, 32.305]
y[1]          -0.0280  8.163e-02     -0.343      0.731 [ -0.188,  0.132]
                              Volatility Model                              
============================================================================
                 coef    std err          t      P&gt;|t|      95.0% Conf. Int.
----------------------------------------------------------------------------
omega       1947.6921    445.220      4.375  1.216e-05 [1.075e+03,2.820e+03]
alpha[1]       0.5807      0.247      2.351  1.873e-02   [9.656e-02,  1.065]
============================================================================

Covariance estimator: robust
ARCHModelResult, id: 0x79785063a780</code></pre>
</div>
</div>
<p>as before, we can obtain the result container and forecast container as follows</p>
<div id="cell-16" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arch_model(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AR"</span>, q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, lags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]).fit(disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb11-2">fcst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.forecast(horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
</div>
<p>notice the difference of <code>resid</code> and <code>std_resid</code>, as well as the diff between <code>variance</code> and <code>residual_variance</code></p>
<div id="cell-18" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">res.resid[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:].std(), res.std_resid[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:].std()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>(np.float64(58.66084093396231), np.float64(0.9985090629605182))</code></pre>
</div>
</div>
<div id="cell-19" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">fcst.variance</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">h.1</th>
<th data-quarto-table-cell-role="th">h.2</th>
<th data-quarto-table-cell-role="th">h.3</th>
<th data-quarto-table-cell-role="th">h.4</th>
<th data-quarto-table-cell-role="th">h.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">499</td>
<td>23353.942452</td>
<td>15527.507157</td>
<td>10965.954024</td>
<td>8317.077882</td>
<td>6778.893468</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">fcst.residual_variance</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">h.1</th>
<th data-quarto-table-cell-role="th">h.2</th>
<th data-quarto-table-cell-role="th">h.3</th>
<th data-quarto-table-cell-role="th">h.4</th>
<th data-quarto-table-cell-role="th">h.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">499</td>
<td>23353.942452</td>
<td>15509.168033</td>
<td>10953.760756</td>
<td>8308.466659</td>
<td>6772.362326</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="generalized-arch-garch" class="level2">
<h2 class="anchored" data-anchor-id="generalized-arch-garch">Generalized ARCH (GARCH)</h2>
<p>Another generalization of the ARCH model focuses on the conditonal variance specification itself, rather than the conditional mean and the noise distribution. The most prominent example along this line of thinking is the GARCH family, which in its simplest form (zero mean model and lag 1) is specified as follows <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AY_t%20&amp;=%20%20%5Csigma_t%20W_t%20%5C%5C%0A%5Csigma_%7Bt%7D%5E2%20&amp;=%20%5Comega%20+%20%5Calpha%20Y_%7Bt-1%7D%5E2%20+%20%5Cbeta%20%5Csigma_%7Bt-1%7D%5E2%0A%5Cend%7Balign*%7D%0A"> The difference lies in the additional beta parameter which specifies a dependence of the conditional variance on the conditional variance of previous timestamp.</p>
<p>GARCH generalizing ARCH is similar to the way ARMA generalizes AR.</p>
</section>
<section id="introducing-archette" class="level2">
<h2 class="anchored" data-anchor-id="introducing-archette">Introducing <code>archette</code></h2>
<p><code>archette</code> is a simplified implementation of the zero mean GARCH model with iid Gaussian noise.</p>
<p>The existing <code>arch</code> library is amazing and covers many popular GARCH-type models. <code>archette</code> is not meant to replace <code>arch</code> in any way, after all, it supports only a very particular model (undoubtedly a very important one).</p>
<p>The goal of <code>archette</code> is to reduce the complexity of <code>arch</code> (e.g.&nbsp;all the class hierarchy) to highlight only the essence of GARCH model. It is meant to be super hackable so that one can build variants of GARCH models by modifying parts of the source code of <code>archette</code>.</p>
<p>There is only one class <code>GARCHETTE</code> in <code>archette</code> for which implements the methods:</p>
<ul>
<li>fit</li>
<li>nll</li>
<li>forecast_vs</li>
<li>simulate</li>
</ul>
<p>and the properties</p>
<ul>
<li>vs</li>
<li>std_resids</li>
<li>params</li>
</ul>
<p>The API is simple: states are maintained in the instances of the main class rahter than delegated to separate container classes, hopefully reducing some mental overhead for users.</p>
<p>Here is how one can fit a model and inspect the fitted parameters and the corresponding negative log likelihood.</p>
<div id="cell-23" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> archette <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GARCHETTE</span></code></pre></div>
</div>
<div id="cell-24" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng()</span>
<span id="cb17-2">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.standard_normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb17-3">mod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GARCHETTE()</span>
<span id="cb17-4">mod.fit(y)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>&lt;archette.core.GARCHETTE at 0x79785c680590&gt;</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">mod.params</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array([124.94299377,   0.16898145,   0.83101855])</code></pre>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">mod.nll(mod.params)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>np.float64(5832.3224873676845)</code></pre>
</div>
</div>
<section id="model-fitting" class="level4">
<h4 class="anchored" data-anchor-id="model-fitting">Model fitting</h4>
<p>Under the hood, <code>fit</code> calls <code>minimize</code> function in <code>scipy.optimize</code> module to minimize the negative log likelihood (<code>nll</code>).</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?f"> denote the joint distribution of time series <img src="https://latex.codecogs.com/png.latex?y">. By successive conditioning, one can write the nll as <img src="https://latex.codecogs.com/png.latex?%0A-%5Clog%20f(y)%20=%20-%20%5Clog%20f_%5Ctheta(y_0)%20-%20%5Csum_%7Bt=1%7D%5E%7BT%7D%20%5Clog%20f_%7B%5Ctheta%7D(y_t%20%7C%20y_%7B%5B0,t-1%5D%7D)%0A"> where <img src="https://latex.codecogs.com/png.latex?y_%7B%5B0,t-1%5D%7D:=%20(y_0,%20...,%20y_%7Bt-1%7D)"> and <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is the parameter of the model.</p>
<p>Since the marginal distribution at time 0 is unknown, one typically remove the first term and minimize <img src="https://latex.codecogs.com/png.latex?-%5Clog%20f(y%7Cy_0)"> instead, where <img src="https://latex.codecogs.com/png.latex?%0A-%5Clog%20f(y%7Cy_0)%20=%20-%20%5Csum_%7Bt=1%7D%5E%7BT%7D%20%5Clog%20f_%7B%5Ctheta%7D(y_t%20%7C%20y_%7B%5B0,t-1%5D%7D)%0A"> By Gaussian noise assumption and lag 1, we have, up to some unimportant additive constant, <img src="https://latex.codecogs.com/png.latex?%0A-%20%5Clog%20f_%7B%5Ctheta%7D(y_t%20%7C%20y_%7B%5B0,t-1%5D%7D)%20=%20-%20%5Clog%20f_%7B%5Ctheta%7D(y_t%20%7C%20y_%7Bt-1%7D)%20=%20%5Cfrac%7B1%7D%7B2%7D%5CBig(%5Clog%20v_t%20+%20%20%5Cfrac%7By_t%5E2%7D%7Bv_t%7D%5CBig)%0A"> where <img src="https://latex.codecogs.com/png.latex?v_t"> is the conditional variance of <img src="https://latex.codecogs.com/png.latex?y_t"> given <img src="https://latex.codecogs.com/png.latex?y_%7Bt-1%7D"> (which is denoted by <img src="https://latex.codecogs.com/png.latex?%5Csigma_t%5E2"> before).</p>
<p>Notice that <img src="https://latex.codecogs.com/png.latex?v_0"> is not observable, hence one needs to set a sensible initial value, e.g.&nbsp;sample variance of <img src="https://latex.codecogs.com/png.latex?y">.</p>
<p>We define two helper functions, one computes the sequence <img src="https://latex.codecogs.com/png.latex?v">, the other the nll.</p>
<div id="cell-28" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_vs(y, params, sig2_init):</span>
<span id="cb23-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    compute conditional variance by recursion of the GARCH specification</span></span>
<span id="cb23-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb23-5">    om,al,be <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb23-6">    vs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(y.size)</span>
<span id="cb23-7">    vs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sig2_init</span>
<span id="cb23-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,y.size):</span>
<span id="cb23-9">        vs[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> al <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> be <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> vs[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb23-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> vs</span></code></pre></div>
</div>
<div id="cell-29" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _nllgauss(y,params,sig2_init):</span>
<span id="cb24-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb24-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    compute nll of GARCH(1,1) with zero conditional mean and gaussian noise</span></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb24-5">    vs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_vs(y,params, sig2_init)</span>
<span id="cb24-6">    nll <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  np.log(vs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> vs</span>
<span id="cb24-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> nll.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
</div>
<p>Now we are in a good place to start writing the main class.</p>
<div id="cell-31" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.optimize <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> minimize</span></code></pre></div>
</div>
<div id="cell-32" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> GARCHETTE:</span>
<span id="cb26-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""simple garch model"""</span></span>
<span id="cb26-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb26-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb26-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb26-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb26-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb26-8"></span>
<span id="cb26-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fit(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,y:np.ndarray):</span>
<span id="cb26-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""fit y to garch"""</span></span>
<span id="cb26-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y</span>
<span id="cb26-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y.var()  </span>
<span id="cb26-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb26-14">        func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nll</span>
<span id="cb26-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> minimize(</span>
<span id="cb26-16">            func, </span>
<span id="cb26-17">            x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>), </span>
<span id="cb26-18">            bounds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)],</span>
<span id="cb26-19">            constraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb26-20">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ineq"</span>,</span>
<span id="cb26-21">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fun"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb26-22">            }</span>
<span id="cb26-23">         ).x</span>
<span id="cb26-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb26-25">    </span>
<span id="cb26-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> nll(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, params)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb26-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""negative log likelihood of the series at the given params"""</span></span>
<span id="cb26-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit</span>
<span id="cb26-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _nllgauss(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y, params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init)</span>
<span id="cb26-30">    </span>
<span id="cb26-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb26-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> vs(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb26-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _get_vs(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init)</span></code></pre></div>
</div>
<p>We see that the method <code>nll</code> and property <code>vs</code> are just wrappers around the helper functions that we just defined. The <code>fit</code> method, though, needs some attention. For the minimization of nll, apart from the objective function <code>nll</code> and initial value <code>x0</code>, it is also necessary to set bounds and constraints for the variables of <code>nll</code>. We impose the parameters to be non-negative because the sequence <code>v</code> must be non-negative (as squares). Also we need<br>
<img src="https://latex.codecogs.com/png.latex?%0A%5Calpha%20+%20%5Cbeta%20%3C1%0A"> because it is the necessary and sufficnet condition for the stationarity of GARCH(1,1) model. Having these constraints are essential for the optimization to work. Finally, we made an educated guess for the initial value: we set the initial values <img src="https://latex.codecogs.com/png.latex?%5Calpha=%5Cbeta=0.3"> to be away from the boundary of the constrained parameter space. The initial value for <img src="https://latex.codecogs.com/png.latex?%5Comega"> is set based on an important fact about the long term conditional variance: for any <img src="https://latex.codecogs.com/png.latex?t">, as <img src="https://latex.codecogs.com/png.latex?T%5Cto%5Cinfty">: <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5BY_%7Bt+T%7D%5E2%7C%20%5Cmathcal%20F_t%5D%20%5Cto%20%5Cfrac%7B%5Comega%7D%7B1-%5Calpha-%5Cbeta%7D%0A"> If we believe that the sample variance of <code>y</code> approaches the long term conditonal variance, then initialize <code>om=(1-0.3-0.3)* y.var()</code> is indeed sensible.</p>
<p>Now it remains to forecast conditional variances (or equivalently conditional volatilities) and simulate paths. For variance forecast, the recursion for <img src="https://latex.codecogs.com/png.latex?h%5Cge%202"> is simpler than that of the GARCH specification: <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5BY%5E2_%7Bt+h%7D%7C%20%5Cmathcal%20F_t%5D%20=%20%5Comega%20%20+%20%5Calpha%20%5Cmathbb%20E%5BY%5E2_%7Bt+h-1%7D%7C%5Cmathcal%20F_%7Bt%7D%5D%20+%20%5Cbeta%20%5Cmathbb%20E%5B%5Csigma%5E2_%7Bt+h-1%7D%7C%5Cmathcal%20F_%7Bt%7D%5D%0A=%20%5Comega%20%20+%20(%5Calpha%20+%5Cbeta)%20%5Cmathbb%20E%5BY%5E2_%7Bt+h-1%7D%7C%5Cmathcal%20F_%7Bt%7D%5D%0A"> This leads to</p>
<div id="cell-35" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _make_fcst_vs(params,last_v, last_y, horizon):</span>
<span id="cb27-2">    om,al,be <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb27-3">    fcst_vs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty(horizon)</span>
<span id="cb27-4">    fcst_vs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> al<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> last_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> be<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> last_v</span>
<span id="cb27-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,horizon):</span>
<span id="cb27-6">        fcst_vs[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (al<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>be) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> fcst_vs[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb27-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fcst_vs</span></code></pre></div>
</div>
<p>The simulation helper function is rather straightforward. We leave the possibility of specifying noises <code>ws</code> to the user.</p>
<div id="cell-37" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _simulate(params, last_y, last_v, horizon, n_rep, seed, ws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb28-2">    om,al,be <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb28-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ws <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb28-4">        np.random.seed(seed)</span>
<span id="cb28-5">        ws <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(n_rep,horizon)</span>
<span id="cb28-6">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty((n_rep, horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb28-7">    v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty((n_rep, horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb28-8">    y[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> last_y</span>
<span id="cb28-9">    v[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> last_v</span>
<span id="cb28-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb28-11">        v[:,i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> om <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> al<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y[:,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> be <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v[:,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb28-12">        y[:,i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(v[:,i]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ws[:,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb28-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]</span></code></pre></div>
</div>
<p>Combining everything, here is all there is in the <code>archette</code> library.</p>
<div id="cell-39" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb29-2"></span>
<span id="cb29-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> GARCHETTE:</span>
<span id="cb29-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""simple garch model"""</span></span>
<span id="cb29-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb29-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb29-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb29-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb29-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb29-10"></span>
<span id="cb29-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fit(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,y:np.ndarray):</span>
<span id="cb29-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""fit y to garch"""</span></span>
<span id="cb29-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y</span>
<span id="cb29-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y.var()  </span>
<span id="cb29-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb29-16">        func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nll</span>
<span id="cb29-17">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> minimize(</span>
<span id="cb29-18">            func, </span>
<span id="cb29-19">            x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>), </span>
<span id="cb29-20">            bounds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)],</span>
<span id="cb29-21">            constraints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb29-22">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ineq"</span>,</span>
<span id="cb29-23">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fun"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb29-24">            }</span>
<span id="cb29-25">         ).x</span>
<span id="cb29-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb29-27">    </span>
<span id="cb29-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> nll(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, params)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb29-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""negative log likelihood of the series at the given params"""</span></span>
<span id="cb29-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit</span>
<span id="cb29-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _nllgauss(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y, params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init)</span>
<span id="cb29-32">    </span>
<span id="cb29-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb29-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> vs(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb29-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit</span>
<span id="cb29-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _get_vs(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._v_init)</span>
<span id="cb29-37">    </span>
<span id="cb29-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb29-39">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> std_resids(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb29-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit</span>
<span id="cb29-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vs)</span>
<span id="cb29-42"></span>
<span id="cb29-43">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forecast_vs(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, </span>
<span id="cb29-44">                    horizon:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb29-45">                    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb29-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""forecast conditional variance in the horizon"""</span></span>
<span id="cb29-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit</span>
<span id="cb29-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _make_fcst_vs(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vs[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], horizon)</span>
<span id="cb29-49"></span>
<span id="cb29-50">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simulate(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, </span>
<span id="cb29-51">                    horizon:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># path length</span></span>
<span id="cb29-52">                    method:Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bootstrap"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"simulate"</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"simulate"</span>,<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "bootstrap" resamples from past std_resids; "simulate" simulates gaussian nosie</span></span>
<span id="cb29-53">                    n_rep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1_000</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of repetitions</span></span>
<span id="cb29-54">                    seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray: </span>
<span id="cb29-55">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._is_fit</span>
<span id="cb29-56">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> method <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bootstrap"</span>:</span>
<span id="cb29-57">            np.random.seed(seed)</span>
<span id="cb29-58">            ws <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.std_resids, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_rep, horizon),replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb29-59">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>: ws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb29-60">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _simulate(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vs[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], horizon, n_rep, seed, ws)</span></code></pre></div>
</div>
</section>
</section>
<section id="sanity-check" class="level2">
<h2 class="anchored" data-anchor-id="sanity-check">Sanity check</h2>
<p>We define GARCH model with both <code>arch</code> and <code>archette</code>, we see that when the model is mis-specified, the MLE found different parameters.</p>
<div id="cell-42" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">mod_arch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arch_model(y, mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zero'</span>, dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>, rescale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>).fit(disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb30-2">mod_archette <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GARCHETTE().fit(y)</span></code></pre></div>
</div>
<div id="cell-43" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">mod_arch.params</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>omega       30.588087
alpha[1]     0.073224
beta[1]      0.926776
Name: params, dtype: float64</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">mod_archette.params</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>array([124.94299377,   0.16898145,   0.83101855])</code></pre>
</div>
</div>
<p>What if model is well specified ?</p>
<div id="cell-46" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">y_sim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mod_archette.simulate(horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, n_rep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">89</span>).squeeze()</span></code></pre></div>
</div>
<div id="cell-47" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">arch_model(y_sim, mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zero'</span>, dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>, rescale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>).fit(disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>).params</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>omega       622.399179
alpha[1]      0.172894
beta[1]       0.795693
Name: params, dtype: float64</code></pre>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">GARCHETTE().fit(y_sim).params</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array([5.98300620e+02, 1.66863034e-01, 8.02092039e-01])</code></pre>
</div>
</div>
<p>The estimated parameters using <code>arch</code> and <code>archette</code> are quite close. Hoorey!</p>


</section>

 ]]></description>
  <category>time series</category>
  <category>python</category>
  <guid>https://xiaochuany.github.io/1principle/posts/202410/tscm.html</guid>
  <pubDate>Tue, 15 Oct 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Git 101</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/gist/git101.html</link>
  <description><![CDATA[ 





<p>Using git to manage text files (e.g.&nbsp;code files) is inevitable for keeping track of all changes while developing and maintaining a project.</p>
<section id="work-solo" class="level2">
<h2 class="anchored" data-anchor-id="work-solo">Work solo</h2>
<p>Assume that we have cloned a GitHub repo on the disk. For solo project, one might get away with three commands</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add .</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> commit <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MESSAGE"</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> push origin main</span></code></pre></div>
<p>To break down these commands,</p>
<ul>
<li><code>git add .</code> moves all modified and untracked files in the current directory to the staged area, a temporary place for files before incorporating changes.<br>
</li>
<li><code>git commit</code> incorporates changes (locally).</li>
<li><code>git push origin main</code> pushes the commits to remote (GitHub) <code>main</code> branch</li>
</ul>
<p>This is simple enough for beginners to get started. However, when it comes to collaboration within an organization or maintaining/participating non-solo open source project, one needs to learn a few more commands.</p>
</section>
<section id="branching-out" class="level2">
<h2 class="anchored" data-anchor-id="branching-out">Branching out</h2>
<p>the first thing to do is to <code>checkout</code> a new branch when working on a new feature/task</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> checkout <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-b</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"new-feature"</span></span></code></pre></div>
<p>edit as usual then</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add . </span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> commit <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MESSAGE'</span></span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> push origin new-feature</span></code></pre></div>
<p>notice that we push back to the <code>new-feature</code> branch, which will be automatically created in the remote repo.</p>
<p>At this point, we have finished the task at hand and want the main branch to incorporate our edits. We do so by create a pull request, aka PR. The maintainer (could be ourselves) can squash and merge our branch like so</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> merge <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--squash</span> new-feature</span></code></pre></div>
</section>
<section id="handling-conflicts" class="level2">
<h2 class="anchored" data-anchor-id="handling-conflicts">Handling Conflicts</h2>
<p>the assumption we make in the last section is that there are no conflicts between the main branch and our feature branch. Such conflicts can happen if main branch has been updated while we work on the feature branch, and the same code has been touched both our feature branch and the main.</p>
<p>One can rely on the maintainer to handle merge conflict but it may not be easy because the maintainer couldnâ€™t know all the details/changes in the feature branch. A common practice is to delegate the handling of conflicts to the owner of the feature branch.</p>
<p>More precisely, the feature branch owner should do</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> checkout main</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> pull</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> checkout new-feature</span>
<span id="cb5-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> rebase main</span></code></pre></div>
<p>let me break this down. We first get the update of main branch. Then we <code>git rebase main</code> to rebase the feature branch on top of the main branch. This means that our changes are treated as if we are branching out from the updated main branch. Conflicts may arise at this stage, and the terminal will let us know. We now manually resolve the conflicts by opening the file in question, remove/keep code chunks as appropriate, then</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add FILE</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> rebase <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--continue</span></span></code></pre></div>
<p>Repeat this until the conflicts are resolved</p>
<p>Now we can push the feature branch back to remote and ask for a PR as before.</p>
</section>
<section id="github-cli" class="level2">
<h2 class="anchored" data-anchor-id="github-cli">GitHub CLI</h2>
<p>GitHub has a delightful CLI which extends git in the context of remote workflow such as creating issues, reviewing PR etc.</p>
<p>For instance, to see the README.md of the repo</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gh</span> repo view </span></code></pre></div>
<p>To create an issue,</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gh</span> issue create</span></code></pre></div>
<p>Remembering a few commonly used commands can streamline the workflow, thus lead to some productivity boost.</p>
</section>
<section id="last-word" class="level2">
<h2 class="anchored" data-anchor-id="last-word">Last word</h2>
<p>This post discuss a small subset of the commands git and gh have to offer. If something is not clear or you need more than what are discussed here, check out the official documentations:</p>
<ul>
<li>git: https://git-scm.com/</li>
<li>gh: https://cli.github.com/</li>
</ul>


</section>

 ]]></description>
  <category>hacks</category>
  <guid>https://xiaochuany.github.io/1principle/posts/gist/git101.html</guid>
  <pubDate>Sat, 13 Apr 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Learn transformer with makemore and torch</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/gist/makemore.html</link>
  <description><![CDATA[ 





<p>[last modified on 2024-03-22]</p>
<section id="makemore" class="level2">
<h2 class="anchored" data-anchor-id="makemore">makemore</h2>
<p>Karpathyâ€™s <a href="https://github.com/karpathy/makemore">makemore</a> is an end-to-end python application that takes in a text file, then generate new text similar to whatâ€™s given. The project <code>makemore</code> is part of his <a href="https://www.youtube.com/playlist?list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ">neural networks: zero to hero</a> lecture series which I recommend to all.</p>
<p>The example dataset in the repo is a large collection of baby names (about 30k names) and the applicaiton trains a <strong>transformer</strong> model to learn the mechanism of naming things, then sample from the learned model.</p>
<p>The purpose of this post is three fold:<br>
- gain familiarity with <strong>transformer</strong><br>
- summarise essential <code>torch</code> functionalities and workflow for building neural nets application<br>
- use minimal tools e.g <code>argparse</code> to produce a command line interface for the app</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
disclaimer
</div>
</div>
<div class="callout-body-container callout-body">
<p>all the code chunks in this post (including docstring) are taken from the <a href="https://github.com/karpathy/makemore">makemore</a> repository</p>
</div>
</div>
</section>
<section id="torch-basics" class="level2">
<h2 class="anchored" data-anchor-id="torch-basics">torch basics</h2>
<div id="a421b774-ac6c-48cf-b592-1d2d1a13431a" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch </span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.utils.data <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Dataset, DataLoader</span></code></pre></div>
</div>
<p>Simplistically, a neural net application is built on two major components: a dataset and a model. The former shapes the behaviour of the latter by optimising some objective function. torch allows us to do both fairly easily and straightforward.</p>
<section id="dataset" class="level3">
<h3 class="anchored" data-anchor-id="dataset">Dataset</h3>
<p><code>Dataset</code> class is a container like a sequence. To define a custom Dataset class, one must implement <code>__init__</code>, <code>__len__</code>, <code>__getitem__</code>, together with transformations relevant to the particular use case of the application. Exampe:</p>
<div id="49c8b793-8053-45f1-80fe-0b631de31e99" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CharDataset(Dataset):</span>
<span id="cb2-2"></span>
<span id="cb2-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, words:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], chars:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, max_word_length:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb2-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> words</span>
<span id="cb2-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chars</span>
<span id="cb2-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_word_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> max_word_length</span>
<span id="cb2-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {ch:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,ch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb2-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i:s <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s,i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.stoi.items()} <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># inverse mapping</span></span>
<span id="cb2-9"></span>
<span id="cb2-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__len__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb2-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.words)</span>
<span id="cb2-12"></span>
<span id="cb2-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> contains(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, word):</span>
<span id="cb2-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> word <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.words</span>
<span id="cb2-15"></span>
<span id="cb2-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_vocab_size(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb2-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.chars) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all the possible characters and special 0 token</span></span>
<span id="cb2-18"></span>
<span id="cb2-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_output_length(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb2-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_word_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;START&gt; token followed by words</span></span>
<span id="cb2-21"></span>
<span id="cb2-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> encode(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, word):</span>
<span id="cb2-23">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.stoi[w] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> word], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span>)</span>
<span id="cb2-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ix</span>
<span id="cb2-25"></span>
<span id="cb2-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> decode(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ix):</span>
<span id="cb2-27">        word <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.itos[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ix)</span>
<span id="cb2-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> word</span>
<span id="cb2-29"></span>
<span id="cb2-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__getitem__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, idx):</span>
<span id="cb2-31">        word <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.words[idx]</span>
<span id="cb2-32">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.encode(word)</span>
<span id="cb2-33">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_word_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span>)</span>
<span id="cb2-34">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_word_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span>)</span>
<span id="cb2-35">        x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ix)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ix</span>
<span id="cb2-36">        y[:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ix)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ix</span>
<span id="cb2-37">        y[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ix)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># index -1 will mask the loss at the inactive locations</span></span>
<span id="cb2-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x, y</span></code></pre></div>
</div>
<p>The custom transformations in this example consists of mapping character to integer, aka tokenisation. There is one special token <code>0</code> representing both the start of name and end of name. We can loop through or get at index a CharDataset because we have implemented sufficient dunder methods for this.</p>
<div id="d6ba078a-b7bf-4750-bc01-779b0f03474b" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> string</span>
<span id="cb3-2"></span>
<span id="cb3-3">examples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharDataset([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'emma'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'richard'</span>], string.ascii_letters, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb3-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> e <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> examples:</span>
<span id="cb3-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(e)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(tensor([ 0,  5, 13, 13,  1,  0,  0,  0,  0,  0,  0]), tensor([ 5, 13, 13,  1,  0, -1, -1, -1, -1, -1, -1]))
(tensor([ 0, 18,  9,  3,  8,  1, 18,  4,  0,  0,  0]), tensor([18,  9,  3,  8,  1, 18,  4,  0, -1, -1, -1]))</code></pre>
</div>
</div>
<div id="5dc7bfcc-8842-4277-bc65-1ce40a6a3dc7" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(examples[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(tensor([ 0,  5, 13, 13,  1,  0,  0,  0,  0,  0,  0]), tensor([ 5, 13, 13,  1,  0, -1, -1, -1, -1, -1, -1]))</code></pre>
</div>
</div>
<p>Letâ€™s break down the output tuple <code>x,y</code>.</p>
<section id="x-tensor" class="level4">
<h4 class="anchored" data-anchor-id="x-tensor"><code>x</code> tensor</h4>
<p>It starts with <code>0</code> token, then each input character gets mapped to an integer from 1 to 26, with trailing zeros if the length of name is less than <code>max_word_length</code> (set to be max length of names in the dataset)</p>
</section>
<section id="y-tensor" class="level4">
<h4 class="anchored" data-anchor-id="y-tensor"><code>y</code> tensor</h4>
<p>By definition, it is the same as <code>x</code> shifted by 1 token to the left, modulo extra subtleties with the trailing -1. What is going on here? Well, in language modelling, the learning task is next token prediction, so at index <code>idx</code> such that <code>x[idx].item()!=0</code>, given <code>x[:idx+1]</code>, the goal is to predict <code>x[idx+1]</code> which by definition is nothing but <code>y[idx]</code>. If <code>x[idx].item()==0</code>, then there is nothing to predict (name finished), we set by convention <code>y[idx]=-1</code>.</p>
<p>Our ultimate goal is to build and train a neural net which can learn from the 30k <code>x,y</code> tuples a good way of sampling next token given some context. Concetely, throw a <code>0</code> token at the model and let the model sample the next token <code>t1</code>, concatenate it with <code>0</code>, then sample next given <code>[0,t1]</code>, until a <code>0</code> token is sampled which means we have arrived at the end of a name. Repeat this to produce as many names as we want. Weâ€™ll get back to inference later.</p>
</section>
</section>
<section id="dataloader" class="level3">
<h3 class="anchored" data-anchor-id="dataloader">DataLoader</h3>
<p>For efficiencyâ€™s sake, it is beneficial to stack multiple examples together, aka mini-batch, and process them all at once. The <code>DataLoader</code> class is meant to help us with this. Example:</p>
<div id="7fd9a3f8-bcca-47b0-9cb8-bb632f9e85f6" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> InfiniteDataLoader:</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    this is really hacky and I'm not proud of it, but there doesn't seem to be</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    a better way in PyTorch to just create an infinite dataloader?</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb7-6"></span>
<span id="cb7-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dataset, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb7-8">        train_sampler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.utils.data.RandomSampler(dataset, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e10</span>))</span>
<span id="cb7-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.train_loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(dataset, sampler<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>train_sampler, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb7-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.data_iter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.train_loader)</span>
<span id="cb7-11"></span>
<span id="cb7-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb7-14">            batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.data_iter)</span>
<span id="cb7-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">StopIteration</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this will technically only happen after 1e10 samples... (i.e. basically never)</span></span>
<span id="cb7-16">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.data_iter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.train_loader)</span>
<span id="cb7-17">            batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.data_iter)</span>
<span id="cb7-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> batch</span></code></pre></div>
</div>
<div id="80355603-6656-43e6-89f1-c43228bfcb30" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharDataset([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'emma'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'richard'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ben'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'steve'</span>],string.ascii_letters, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb8-2">batch_loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InfiniteDataLoader(dataset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</div>
<div id="fcbc76ef-9a1f-4ed4-871a-2ebd1df19764" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>):</span>
<span id="cb9-2">    X,Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch_loader.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>()</span>
<span id="cb9-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># B,T = batch_size, max_word_length+1</span></span>
<span id="cb9-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb9-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B,T)</span></span>
<span id="cb9-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X=tensor([[ 0, 18,  9,  3,  8,  1, 18,  4,  0,  0,  0],
        [ 0, 19, 20,  5, 22,  5,  0,  0,  0,  0,  0]])
------------------------------------------------------------
Y=tensor([[18,  9,  3,  8,  1, 18,  4,  0, -1, -1, -1],
        [19, 20,  5, 22,  5,  0, -1, -1, -1, -1, -1]])
************************************************************
X=tensor([[ 0,  2,  5, 14,  0,  0,  0,  0,  0,  0,  0],
        [ 0, 19, 20,  5, 22,  5,  0,  0,  0,  0,  0]])
------------------------------------------------------------
Y=tensor([[ 2,  5, 14,  0, -1, -1, -1, -1, -1, -1, -1],
        [19, 20,  5, 22,  5,  0, -1, -1, -1, -1, -1]])
************************************************************</code></pre>
</div>
</div>
</section>
<section id="tensor-ops-and-view" class="level3">
<h3 class="anchored" data-anchor-id="tensor-ops-and-view">Tensor ops and View</h3>
<p>Tensor is the most fundamental data structure for neural nets.</p>
<p>A tensor is a collection of numbers index by tuple of non-negative integers. In the above, weâ€™ve seen that a batch <code>X</code> is 2d tensor wit shape (B,T), we can index <code>X[b,t]</code> for b in range(B) and t in range(T).</p>
<p>torch provides optimised tensor operations and auto differentiation engine. Rather than understanding low level optimisations (parallel programming as in e.g.&nbsp;cuda kernels), we just take these optimisations for granted in this post and we only concerned with what we can build with <code>Tensor</code>.</p>
<p>torch ops usually create new tensor as output. e.g.&nbsp;<code>torch.cat</code>, <code>torch.stack</code>.</p>
<p>In contrast, Tensor View avoids wasteful data copy.</p>
<p>Here are a few common view ops.</p>
<ul>
<li>basic slicing and indexing (following numpy)<br>
</li>
<li><code>view</code><br>
</li>
<li><code>split</code><br>
</li>
<li><code>unsqueeze</code><br>
</li>
<li><code>expand</code></li>
</ul>
<p>For a full list of view ops, refer to <a href="https://pytorch.org/docs/stable/tensor_view.html">docs</a>.</p>
<div id="97c1e291-6d38-413c-907b-1e87bb84aa01" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0,  1],
         [ 2,  3],
         [ 4,  5],
         [ 6,  7]],

        [[ 8,  9],
         [10, 11],
         [12, 13],
         [14, 15]],

        [[16, 17],
         [18, 19],
         [20, 21],
         [22, 23]]])</code></pre>
</div>
</div>
<div id="991ce1da-b121-4053-803e-64736e33771b" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.equal(torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</div>
<div id="3460478e-e2af-4976-9e53-7113b393df55" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">torch.tril(torch.ones(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1., 0., 0., 0.],
        [1., 1., 0., 0.],
        [1., 1., 1., 0.],
        [1., 1., 1., 1.]])</code></pre>
</div>
</div>
<div id="fe5e7052-e605-4459-96b9-2bd91b911cd9" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>).split(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># a tuple of 4/2 tensors of shape (3,2) </span></span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[-0.1093,  0.0426],
         [ 2.5843,  0.2994],
         [-0.2158, -1.7210]]),
 tensor([[-1.2973,  0.2321],
         [ 1.1551,  0.2394],
         [ 0.4124,  0.1518]]))</code></pre>
</div>
</div>
<div id="ccb3aaa5-f92e-4580-beb4-3d7e960d1035" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1">att <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb18-2">att.masked_fill(torch.tril(torch.ones(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[  0, -99, -99, -99],
        [  4,   5, -99, -99],
        [  8,   9,  10, -99],
        [ 12,  13,  14,  15]])</code></pre>
</div>
</div>
<div id="7a960984-d5bf-4cf8-818e-235cdd14057b" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>).transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb20-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.cat([torch.ones(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb20-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> torch.stack([torch.ones(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</div>
</section>
<section id="module" class="level3">
<h3 class="anchored" data-anchor-id="module">Module</h3>
<p><code>nn.Module</code> is the base class for all neural nets, which, mathemtically, are just functions taking Tensor as input and compute the output as another Tensor. Just as we can compose functions, we can compose Moduleâ€™s to build complicated achitechture.</p>
<p><code>torch</code> offers built-in modules as LEGO pieces. Example:</p>
<ul>
<li><code>nn.Linear</code>: random linear function that takes input dim and output dim as arguments</li>
<li><code>nn.LayerNorm</code>: standardise a tensor over shape (pass in as argument), then multiplied by weight, then add bias (default elementwise 1 and 0).</li>
<li><code>nn.RELU</code>: a parameter-less elementwise non-linear function</li>
<li><code>nn.Embedding</code>: just a random lookup table of shape B,T, n_embd if the input tensor is of shape B,T</li>
</ul>
<p>some container classes:</p>
<ul>
<li><code>nn.ModuleDict</code>: pass in a dictionary of name:instance pairs</li>
<li><code>nn.ModuleList</code>: pass in a list of instances</li>
</ul>
<p>custom Module must implement <code>forward</code> method. Example:</p>
<div id="9314ebbd-4a19-4bed-b5e5-1d75ff05e508" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> NewGELU(nn.Module):</span>
<span id="cb21-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Implementation of the GELU activation function currently in Google BERT repo (identical to OpenAI GPT).</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Reference: Gaussian Error Linear Units (GELU) paper: https://arxiv.org/abs/1606.08415</span></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb21-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb21-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> torch.tanh(math.sqrt(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> math.pi) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.044715</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">pow</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>))))</span></code></pre></div>
</div>
</section>
</section>
<section id="build-transformer" class="level2">
<h2 class="anchored" data-anchor-id="build-transformer">build Transformer</h2>
<p>Transformer is a custom module built on attention blocks, which themselves are built on multi-head attention layers. What we have here is a decoder/GPT.</p>
<p><a href="https://lilianweng.github.io/posts/2023-01-27-the-transformer-family-v2/" title="The Transformer Family Version 2.0">more variants</a></p>
<p>letâ€™s build from the layer level all the way to transformer. here is our model config. Notice that we should have a dataset first, infer from there the necessary config parameters for transformer. For example, the vocab_size is the size of all the possible tokens in the dataset, a value that may vary from dataset to dataset.</p>
<div id="2160e45a-b3df-4605-8c1e-2de212c917d6" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb22-2"></span>
<span id="cb22-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb22-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ModelConfig:</span>
<span id="cb22-5">    block_size: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># length of the input sequences of integers</span></span>
<span id="cb22-6">    vocab_size: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the input integers are in range [0 .. vocab_size -1]</span></span>
<span id="cb22-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters below control the sizes of each model slightly differently</span></span>
<span id="cb22-8">    n_layer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb22-9">    n_embd: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb22-10">    n_embd2: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb22-11">    n_head: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span></code></pre></div>
</div>
<section id="self-attention-layer" class="level3">
<h3 class="anchored" data-anchor-id="self-attention-layer">self attention layer</h3>
<p>The input of attn is 3d tensor of shape (B,T,C). The forward step of attention undergoes a few steps</p>
<ul>
<li>linear C-&gt; 3C, split into qkv<br>
</li>
<li>view C -&gt; (nh, C/nh) as heads<br>
</li>
<li>compute attention matrix with qk, which is used to average v<br>
</li>
<li>re-assemble all heads to (B,T,C) then project</li>
</ul>
<div id="2be828be-16cd-40ac-9090-4c9210c665bf" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CausalSelfAttention(nn.Module):</span>
<span id="cb23-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A vanilla multi-head masked self-attention layer with a projection at the end.</span></span>
<span id="cb23-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    It is possible to use torch.nn.MultiheadAttention here but I am including an</span></span>
<span id="cb23-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    explicit implementation here to show that there is nothing too scary here.</span></span>
<span id="cb23-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb23-7"></span>
<span id="cb23-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, config):</span>
<span id="cb23-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb23-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> config.n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> config.n_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb23-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># key, query, value projections for all heads, but in a batch</span></span>
<span id="cb23-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c_attn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(config.n_embd, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> config.n_embd)</span>
<span id="cb23-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output projection</span></span>
<span id="cb23-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c_proj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(config.n_embd, config.n_embd)</span>
<span id="cb23-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># causal mask to ensure that attention is only applied to the left in the input sequence</span></span>
<span id="cb23-16">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.register_buffer(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bias"</span>, torch.tril(torch.ones(config.block_size, config.block_size))</span>
<span id="cb23-17">                                     .view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, config.block_size, config.block_size))</span>
<span id="cb23-18">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> config.n_head</span>
<span id="cb23-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> config.n_embd</span>
<span id="cb23-20"></span>
<span id="cb23-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb23-22">        B, T, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.size() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch size, sequence length, embedding dimensionality (n_embd)</span></span>
<span id="cb23-23"></span>
<span id="cb23-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate query, key, values for all heads in batch and move head forward to be the batch dim</span></span>
<span id="cb23-25">        q, k ,v  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c_attn(x).split(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_embd, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb23-26">        k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k.view(B, T, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head).transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B, nh, T, hs)</span></span>
<span id="cb23-27">        q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q.view(B, T, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head).transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B, nh, T, hs)</span></span>
<span id="cb23-28">        v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v.view(B, T, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_head).transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B, nh, T, hs)</span></span>
<span id="cb23-29"></span>
<span id="cb23-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># causal self-attention; Self-attend: (B, nh, T, hs) x (B, nh, hs, T) -&gt; (B, nh, T, T)</span></span>
<span id="cb23-31">        att <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> k.transpose(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> math.sqrt(k.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb23-32">        att <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> att.masked_fill(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias[:,:,:T,:T] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-inf'</span>))</span>
<span id="cb23-33">        att <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(att, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb23-34">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> att <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> v <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B, nh, T, T) x (B, nh, T, hs) -&gt; (B, nh, T, hs)</span></span>
<span id="cb23-35">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y.transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).contiguous().view(B, T, C) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># re-assemble all head outputs side by side</span></span>
<span id="cb23-36"></span>
<span id="cb23-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output projection</span></span>
<span id="cb23-38">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c_proj(y)</span>
<span id="cb23-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span></code></pre></div>
</div>
<p>This is pretty self-explanatory. donâ€™t forget <code>super().__init__()</code></p>
<p>A bit of caution here in line 35: <code>transpose</code> is a non-contiguous view op of the base tensor, which has performance penalty if not making it <code>contingous</code>. Also:</p>
<div id="e0ee02b0-4698-45db-ac1e-c8603fcedea3" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb24-2">torch.ne(x.transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).contiguous().view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), x.view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[False, False,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True, False, False]])</code></pre>
</div>
</div>
</section>
<section id="block" class="level3">
<h3 class="anchored" data-anchor-id="block">block</h3>
<p>Stack attention layer and mlp, with layer normalization as well as residual connections to <a href="https://www.youtube.com/watch?v=D_jt-xO_RmI&amp;t=3814s" title="Kaiming He - deep learning bootcamp MIT">facilitate training</a>.</p>
<div id="49f7dd9e-2e11-4c90-bf0a-8b18fba0e376" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Block(nn.Module):</span>
<span id="cb26-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" an unassuming Transformer block """</span></span>
<span id="cb26-3"></span>
<span id="cb26-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, config):</span>
<span id="cb26-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb26-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ln_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.LayerNorm(config.n_embd)</span>
<span id="cb26-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CausalSelfAttention(config)</span>
<span id="cb26-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ln_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.LayerNorm(config.n_embd)</span>
<span id="cb26-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mlp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.ModuleDict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(</span>
<span id="cb26-10">            c_fc    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(config.n_embd, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> config.n_embd),</span>
<span id="cb26-11">            c_proj  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> config.n_embd, config.n_embd),</span>
<span id="cb26-12">            act     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NewGELU(),</span>
<span id="cb26-13">        ))</span>
<span id="cb26-14">        m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mlp</span>
<span id="cb26-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mlpf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: m.c_proj(m.act(m.c_fc(x))) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MLP forward</span></span>
<span id="cb26-16"></span>
<span id="cb26-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb26-18">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attn(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ln_1(x))</span>
<span id="cb26-19">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mlpf(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ln_2(x))</span>
<span id="cb26-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span></code></pre></div>
</div>
</section>
<section id="the-entire-thing" class="level3">
<h3 class="anchored" data-anchor-id="the-entire-thing">the entire thing</h3>
<p>token embedding + potitional embedding, then pass through layers of blocks, layer normalization, finally projection.</p>
<div id="39e9b92d-50d6-4b72-9221-3d134b7dbd2c" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Transformer(nn.Module):</span>
<span id="cb27-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Transformer Language Model, exactly as seen in GPT-2 """</span></span>
<span id="cb27-3"></span>
<span id="cb27-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, config):</span>
<span id="cb27-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb27-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> config.block_size</span>
<span id="cb27-7"></span>
<span id="cb27-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.transformer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.ModuleDict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(</span>
<span id="cb27-9">            wte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Embedding(config.vocab_size, config.n_embd),</span>
<span id="cb27-10">            wpe <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Embedding(config.block_size, config.n_embd),</span>
<span id="cb27-11">            h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.ModuleList([Block(config) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(config.n_layer)]),</span>
<span id="cb27-12">            ln_f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.LayerNorm(config.n_embd),</span>
<span id="cb27-13">        ))</span>
<span id="cb27-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lm_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(config.n_embd, config.vocab_size, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb27-15"></span>
<span id="cb27-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># report number of parameters (note we don't count the decoder parameters in lm_head)</span></span>
<span id="cb27-17">        n_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.numel() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.transformer.parameters())</span>
<span id="cb27-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of parameters: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">M"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (n_params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>,))</span>
<span id="cb27-19"></span>
<span id="cb27-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_block_size(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb27-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.block_size</span>
<span id="cb27-22"></span>
<span id="cb27-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, idx, targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb27-24">        device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idx.device</span>
<span id="cb27-25">        b, t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idx.size()</span>
<span id="cb27-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.block_size, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cannot forward sequence of length </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, block size is only </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>block_size<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb27-27">        pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, t, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape (1, t)</span></span>
<span id="cb27-28"></span>
<span id="cb27-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward the GPT model itself</span></span>
<span id="cb27-30">        tok_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.transformer.wte(idx) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># token embeddings of shape (b, t, n_embd)</span></span>
<span id="cb27-31">        pos_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.transformer.wpe(pos) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># position embeddings of shape (1, t, n_embd)</span></span>
<span id="cb27-32">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tok_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> pos_emb</span>
<span id="cb27-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> block <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.transformer.h:</span>
<span id="cb27-34">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block(x)</span>
<span id="cb27-35">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.transformer.ln_f(x)</span>
<span id="cb27-36">        logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lm_head(x)</span>
<span id="cb27-37"></span>
<span id="cb27-38">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if we are given some desired targets also calculate the loss</span></span>
<span id="cb27-39">        loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb27-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> targets <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb27-41">            loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, logits.size(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), targets.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb27-42"></span>
<span id="cb27-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> logits, loss</span></code></pre></div>
</div>
<p>Note: <code>F.cross_entropy</code> caveats</p>
<ul>
<li>expect ground truth of shape (D,)<br>
</li>
<li>expect predictions of shape (D,C) where C is the number of classes<br>
</li>
<li>use <code>logtis</code> for prediction (which is one <code>F.softmax</code> away from probability)<br>
</li>
<li><code>ignore_index=-1</code> matches <code>-1</code> in the definition of <code>y</code>in <code>CharDataset</code></li>
</ul>
</section>
</section>
<section id="evaluation" class="level2">
<h2 class="anchored" data-anchor-id="evaluation">evaluation</h2>
<p>the evaluation code is standard. Note:</p>
<ul>
<li>DataLoader can be looped through.<br>
</li>
<li>batch is a tuple of tensors each of shape (B, T)</li>
</ul>
<p>I am however not sure what are the benefits of entering the inference mode, given that code has already switched on model.eval(). TODO!</p>
<div id="b826bc25-2273-4561-8fd7-99ef14567437" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.inference_mode</span>()</span>
<span id="cb28-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate(model, dataset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, max_batches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb28-3">    model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb28-4">    loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(dataset, shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch_size, num_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb28-5">    losses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, batch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(loader):</span>
<span id="cb28-7">        batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [t.to(args.device) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> batch]</span>
<span id="cb28-8">        X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch</span>
<span id="cb28-9">        logits, loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(X, Y)</span>
<span id="cb28-10">        losses.append(loss.item())</span>
<span id="cb28-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> max_batches <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> max_batches:</span>
<span id="cb28-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb28-13">    mean_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(losses).mean().item()</span>
<span id="cb28-14">    model.train() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reset model back to training mode</span></span>
<span id="cb28-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mean_loss</span></code></pre></div>
</div>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">inference</h2>
<p>Given some context, generate things with trained model (no gradient update) one token at a time. This involves concat a generated token with the context, then pass the combined new context back into the model to get the next token, and so on â€¦</p>
<div id="ac0c25f7-64d1-4a78-a055-064efd4862b1" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>()</span>
<span id="cb29-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate(model, idx, max_new_tokens, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, do_sample<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb29-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb29-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span></span>
<span id="cb29-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    the sequence max_new_tokens times, feeding the predictions back into the model each time.</span></span>
<span id="cb29-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Most likely you'll want to make sure to be in model.eval() mode of operation for this.</span></span>
<span id="cb29-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb29-8">    block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.get_block_size()</span>
<span id="cb29-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_new_tokens):</span>
<span id="cb29-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if the sequence context is growing too long we must crop it at block_size</span></span>
<span id="cb29-11">        idx_cond <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idx <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> idx.size(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> block_size <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> idx[:, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>block_size:]</span>
<span id="cb29-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward the model to get the logits for the index in the sequence</span></span>
<span id="cb29-13">        logits, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(idx_cond)</span>
<span id="cb29-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pluck the logits at the final step and scale by desired temperature</span></span>
<span id="cb29-15">        logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits[:, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> temperature</span>
<span id="cb29-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optionally crop the logits to only the top k options</span></span>
<span id="cb29-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> top_k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb29-18">            v, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.topk(logits, top_k)</span>
<span id="cb29-19">            logits[logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v[:, [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Inf'</span>)</span>
<span id="cb29-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply softmax to convert logits to (normalized) probabilities</span></span>
<span id="cb29-21">        probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># either sample from the distribution or take the most likely element</span></span>
<span id="cb29-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> do_sample:</span>
<span id="cb29-24">            idx_next <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(probs, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb29-26">            _, idx_next <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.topk(probs, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># append sampled index to the running sequence and continue</span></span>
<span id="cb29-28">        idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat((idx, idx_next), dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-29"></span>
<span id="cb29-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> idx</span></code></pre></div>
</div>
</section>
<section id="tie-it-all-up" class="level2">
<h2 class="anchored" data-anchor-id="tie-it-all-up">tie it all up</h2>
<div id="8e1c1f5f-90de-4d00-95ca-727d421d3cf0" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb30-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb30-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb30-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb30-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> argparse</span></code></pre></div>
</div>
<section id="argparse" class="level3">
<h3 class="anchored" data-anchor-id="argparse">argparse</h3>
<p><a href="https://docs.python.org/3/library/argparse.html#module-argparse">argparse</a> module is in the python standard library centring around the <code>ArgumentParser</code> class, which has the <code>add_argument()</code> method and <code>parse_args()</code> method.</p>
<p>When no specific value is given for a flag, the parser will use the default value. Alternatively, one can use <code>action</code> to store some specific value for instance a boolean. If neither exists, then the value of the flag is <code>None</code>.</p>
<p>Calling <code>parse_args()</code> returns a <code>Namespace</code> object which stores arguments and values.</p>
<p>Recall that the python built-in <code>vars</code> calls the <code>__dict__</code> of a class.</p>
<div id="27438b93-71c9-40fa-b5f0-9f5792123cb7" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parse command line args</span></span>
<span id="cb31-2">parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> argparse.ArgumentParser(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Make More"</span>)</span>
<span id="cb31-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># system/input/output</span></span>
<span id="cb31-4">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--input-file'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-i'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'names.txt'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input file with things one per line"</span>)</span>
<span id="cb31-5">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--work-dir'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-o'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'out'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output working directory"</span>)</span>
<span id="cb31-6">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--resume'</span>, action<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'store_true'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"when this flag is used, we will resume optimization from existing model in the workdir"</span>)</span>
<span id="cb31-7">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--sample-only'</span>, action<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'store_true'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"just sample from the model and quit, don't train"</span>)</span>
<span id="cb31-8">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--num-workers'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-n'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of data workers for both train/test"</span>)</span>
<span id="cb31-9">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--max-steps'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max number of optimization steps to run for, or -1 for infinite."</span>)</span>
<span id="cb31-10">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--device'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cpu'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"device to use for compute, examples: cpu|cuda|cuda:2|mps"</span>)</span>
<span id="cb31-11">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--seed'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3407</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seed"</span>)</span>
<span id="cb31-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sampling</span></span>
<span id="cb31-13">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--top-k'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top-k for sampling, -1 means no top-k"</span>)</span>
<span id="cb31-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model</span></span>
<span id="cb31-15">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--type'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'transformer'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model class type to use, bigram|mlp|rnn|gru|bow|transformer"</span>)</span>
<span id="cb31-16">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--n-layer'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of layers"</span>)</span>
<span id="cb31-17">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--n-head'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of heads (in a transformer)"</span>)</span>
<span id="cb31-18">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--n-embd'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of feature channels in the model"</span>)</span>
<span id="cb31-19">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--n-embd2'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of feature channels elsewhere in the model"</span>)</span>
<span id="cb31-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optimization</span></span>
<span id="cb31-21">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--batch-size'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-b'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"batch size during optimization"</span>)</span>
<span id="cb31-22">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--learning-rate'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-l'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-4</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"learning rate"</span>)</span>
<span id="cb31-23">parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--weight-decay'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-w'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weight decay"</span>)</span>
<span id="cb31-24"></span>
<span id="cb31-25">args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parse_args()</span>
<span id="cb31-26"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>(args))</span></code></pre></div>
</div>
</section>
<section id="inits" class="level3">
<h3 class="anchored" data-anchor-id="inits">inits</h3>
<p>we run things in order</p>
<ul>
<li>init a dataset and let it determine part of model config<br>
</li>
<li>init model with config<br>
</li>
<li>init optimiser and dataloader</li>
</ul>
<div id="aef4b13a-58f6-4d1b-9e53-983bd8346af5" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># system inits</span></span>
<span id="cb32-2">torch.manual_seed(args.seed)</span>
<span id="cb32-3">torch.cuda.manual_seed_all(args.seed)</span>
<span id="cb32-4">os.makedirs(args.work_dir, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb32-5">writer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SummaryWriter(log_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.work_dir)</span>
<span id="cb32-6"></span>
<span id="cb32-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># init datasets</span></span>
<span id="cb32-8">train_dataset, test_dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_datasets(args.input_file)</span>
<span id="cb32-9">vocab_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_dataset.get_vocab_size()</span>
<span id="cb32-10">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_dataset.get_output_length()</span>
<span id="cb32-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"dataset determined that: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>vocab_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-12"></span>
<span id="cb32-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># init model</span></span>
<span id="cb32-14">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ModelConfig(vocab_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vocab_size, block_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>block_size,</span>
<span id="cb32-15">                   n_layer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.n_layer, n_head<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.n_head,</span>
<span id="cb32-16">                   n_embd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.n_embd, n_embd2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.n_embd2)</span>
<span id="cb32-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'transformer'</span>:</span>
<span id="cb32-18">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Transformer(config)</span>
<span id="cb32-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> args.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bigram'</span>:</span>
<span id="cb32-20">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Bigram(config)</span>
<span id="cb32-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> args.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mlp'</span>:</span>
<span id="cb32-22">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MLP(config)</span>
<span id="cb32-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> args.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rnn'</span>:</span>
<span id="cb32-24">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RNN(config, cell_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rnn'</span>)</span>
<span id="cb32-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> args.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gru'</span>:</span>
<span id="cb32-26">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RNN(config, cell_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gru'</span>)</span>
<span id="cb32-27"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> args.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bow'</span>:</span>
<span id="cb32-28">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BoW(config)</span>
<span id="cb32-29"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb32-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'model type </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>args<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is not recognized'</span>)</span>
<span id="cb32-31">model.to(args.device)</span>
<span id="cb32-32"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"model #params: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.numel() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> model.parameters())<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-33"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.resume <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> args.sample_only: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note: if we sample-only then we also assume we are resuming</span></span>
<span id="cb32-34">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"resuming from existing model in the workdir"</span>)</span>
<span id="cb32-35">    model.load_state_dict(torch.load(os.path.join(args.work_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model.pt'</span>)))</span>
<span id="cb32-36"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.sample_only:</span>
<span id="cb32-37">    print_samples(num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb32-38">    sys.exit()</span>
<span id="cb32-39"></span>
<span id="cb32-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># init optimizer</span></span>
<span id="cb32-41">optimizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.optim.AdamW(model.parameters(), lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.learning_rate, weight_decay<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.weight_decay, betas<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>), eps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-8</span>)</span>
<span id="cb32-42"></span>
<span id="cb32-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># init dataloader</span></span>
<span id="cb32-44">batch_loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InfiniteDataLoader(train_dataset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.batch_size, pin_memory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, num_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args.num_workers)</span></code></pre></div>
</div>
</section>
<section id="training-loop" class="level3">
<h3 class="anchored" data-anchor-id="training-loop">training loop</h3>
<p>runs forever, save the <code>model.state_dict()</code> when a lower test loss is achieved</p>
<div id="6df6dc75-1ab2-4048-a79d-2b2e43dde577" class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># training loop</span></span>
<span id="cb33-2">best_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb33-3">step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb33-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb33-5"></span>
<span id="cb33-6">    t0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb33-7"></span>
<span id="cb33-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the next batch, ship to device, and unpack it to input and target</span></span>
<span id="cb33-9">    batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch_loader.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>()</span>
<span id="cb33-10">    batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [t.to(args.device) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> batch]</span>
<span id="cb33-11">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch</span>
<span id="cb33-12"></span>
<span id="cb33-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># feed into the model</span></span>
<span id="cb33-14">    logits, loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(X, Y)</span>
<span id="cb33-15"></span>
<span id="cb33-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate the gradient, update the weights</span></span>
<span id="cb33-17">    model.zero_grad(set_to_none<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb33-18">    loss.backward()</span>
<span id="cb33-19">    optimizer.step()</span>
<span id="cb33-20"></span>
<span id="cb33-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># wait for all CUDA work on the GPU to finish then calculate iteration time taken</span></span>
<span id="cb33-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.device.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda'</span>):</span>
<span id="cb33-23">        torch.cuda.synchronize()</span>
<span id="cb33-24">    t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb33-25"></span>
<span id="cb33-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># logging</span></span>
<span id="cb33-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb33-28">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"step </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>step<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | loss </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | step time </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(t1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t0)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">ms"</span>)</span>
<span id="cb33-29"></span>
<span id="cb33-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># evaluate the model</span></span>
<span id="cb33-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb33-32">        train_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluate(model, train_dataset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, max_batches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb33-33">        test_loss  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluate(model, test_dataset,  batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, max_batches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb33-34">        writer.add_scalar(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss/train"</span>, train_loss, step)</span>
<span id="cb33-35">        writer.add_scalar(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss/test"</span>, test_loss, step)</span>
<span id="cb33-36">        writer.flush()</span>
<span id="cb33-37">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"step </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>step<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> train loss: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>train_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> test loss: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>test_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-38">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save the model to disk if it has improved</span></span>
<span id="cb33-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> best_loss <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> test_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> best_loss:</span>
<span id="cb33-40">            out_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.path.join(args.work_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model.pt"</span>)</span>
<span id="cb33-41">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"test loss </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>test_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is the best so far, saving model to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-42">            torch.save(model.state_dict(), out_path)</span>
<span id="cb33-43">            best_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_loss</span>
<span id="cb33-44"></span>
<span id="cb33-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the model</span></span>
<span id="cb33-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb33-47">        print_samples(num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb33-48"></span>
<span id="cb33-49">    step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb33-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># termination conditions</span></span>
<span id="cb33-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> args.max_steps:</span>
<span id="cb33-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span></code></pre></div>
</div>


</section>
</section>

 ]]></description>
  <category>deep learning</category>
  <category>python</category>
  <guid>https://xiaochuany.github.io/1principle/posts/gist/makemore.html</guid>
  <pubDate>Fri, 16 Feb 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>SQL 101</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/gist/sql101.html</link>
  <description><![CDATA[ 





<p>Every professional interacting with data will come across SQL sooner or later. In this post, we cover a core set of vocabulary, grammer, expression for efficient use of this language.</p>
<section id="vocabulary" class="level2">
<h2 class="anchored" data-anchor-id="vocabulary">vocabulary</h2>
<p><code>from</code> <code>where</code> <code>group by</code> <code>having</code> <code>select</code> <code>distinct</code> <code>union</code> <code>order by</code> <code>limit/fetch first rows only</code></p>
<p>these vocabularies are fundamental in the day to day usage of SQL. They are listed in the execution order as well, meaning that the <code>from</code> clause first gets executed (which table do we want), then <code>where</code> (which row) and so on. We donâ€™t have to include all the clauses in one query, but if we do, then knowing the order in which they are executed matters, especially for debugging errors.</p>
<p>In this post, we use a jupyter kernel called <code>xsqlite</code> with <code>sqlite3</code> backend (the most commonly used in-memory database) to demonstrate the SQL language. To install the kernel, plesae visit <a href="https://xeus-sqlite.readthedocs.io/en/latest/getting_started.html">here</a>.</p>
<p>Here are simple queries with some of the vocabs.</p>
<div id="450341c6" class="cell">
<pre class="sqlite cell-code"><code>%load ../assets/tutorial.db</code></pre>
</div>
<div id="85e3ee60-b575-4024-bdf4-50fc87cb686a" class="cell">
<pre class="sqlite cell-code"><code>select * from customers limit 5</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">name</td>
<td data-quarto-table-cell-role="th">visited_on</td>
<td data-quarto-table-cell-role="th">amount</td>
</tr>
<tr class="even">
<td>1</td>
<td>Jhon</td>
<td>2019-01-01</td>
<td>100</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Daniel</td>
<td>2019-01-02</td>
<td>110</td>
</tr>
<tr class="even">
<td>3</td>
<td>Jade</td>
<td>2019-01-03</td>
<td>120</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Khaled</td>
<td>2019-01-04</td>
<td>130</td>
</tr>
<tr class="even">
<td>5</td>
<td>Winston</td>
<td>2019-01-05</td>
<td>110</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="1cacf302-49ec-4533-a52a-858890c06aa4" class="cell">
<pre class="sqlite cell-code"><code>select * from customers where customer_id&lt;3</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">name</td>
<td data-quarto-table-cell-role="th">visited_on</td>
<td data-quarto-table-cell-role="th">amount</td>
</tr>
<tr class="even">
<td>1</td>
<td>Jhon</td>
<td>2019-01-01</td>
<td>100</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Daniel</td>
<td>2019-01-02</td>
<td>110</td>
</tr>
<tr class="even">
<td>1</td>
<td>Jhon</td>
<td>2019-01-10</td>
<td>130</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="2929fc9b-a230-4e28-9f3b-11008e8b20c5" class="cell">
<pre class="sqlite cell-code"><code>select * from customers where customer_id=2
union
select * from customers where customer_id=2</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">name</td>
<td data-quarto-table-cell-role="th">visited_on</td>
<td data-quarto-table-cell-role="th">amount</td>
</tr>
<tr class="even">
<td>2</td>
<td>Daniel</td>
<td>2019-01-02</td>
<td>110</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="fae34340-27a5-43af-92a8-bfa17f5aaad9" class="cell">
<pre class="sqlite cell-code"><code>select * from customers where customer_id=2
union all
select * from customers where customer_id=2</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">name</td>
<td data-quarto-table-cell-role="th">visited_on</td>
<td data-quarto-table-cell-role="th">amount</td>
</tr>
<tr class="even">
<td>2</td>
<td>Daniel</td>
<td>2019-01-02</td>
<td>110</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Daniel</td>
<td>2019-01-02</td>
<td>110</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="0106e814-6b6c-4db0-8c56-64f06b8d79e2" class="cell">
<pre class="sqlite cell-code"><code>select distinct customer_id, visited_on 
from customers 
order by visited_on, customer_id</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">visited_on</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2019-01-02</td>
</tr>
<tr class="even">
<td>3</td>
<td>2019-01-03</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2019-01-04</td>
</tr>
<tr class="even">
<td>5</td>
<td>2019-01-05</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2019-01-06</td>
</tr>
<tr class="even">
<td>7</td>
<td>2019-01-07</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2019-01-08</td>
</tr>
<tr class="even">
<td>9</td>
<td>2019-01-09</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2019-01-10</td>
</tr>
<tr class="even">
<td>3</td>
<td>2019-01-10</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="aggregate-function" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-function">aggregate function</h2>
<p>It is very common that one wants summary statistics of different group of people/items/products. In SQL, this is done with the <code>group by</code> clause together with aggregate function(s).</p>
<div id="067a8c3d-8211-4878-8e4d-4ac407cd203c" class="cell">
<pre class="sqlite cell-code"><code>select customer_id, min(visited_on), count(*) 
from customers 
where customer_id&lt;3 
group by customer_id</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">min(visited_on)</td>
<td data-quarto-table-cell-role="th">count(*)</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-01</td>
<td>2</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2019-01-02</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="387ea267-880b-4291-bbe0-0e38b5f1f1c5" class="cell">
<pre class="sqlite cell-code"><code>select customer_id, min(visited_on), count(*) as cnt 
from customers 
where customer_id&lt;3
group by customer_id 
having cnt=1</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">customer_id</td>
<td data-quarto-table-cell-role="th">min(visited_on)</td>
<td data-quarto-table-cell-role="th">cnt</td>
</tr>
<tr class="even">
<td>2</td>
<td>2019-01-02</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>notice that <code>having</code> and <code>where</code> play a similar role which is to select relevant rows, but one gets executed before <code>group by</code>, the other after.</p>
</section>
<section id="windows-function" class="level2">
<h2 class="anchored" data-anchor-id="windows-function">windows function</h2>
<p>windows function and aggregate function are similar-ish in that they both act on groups (with different synatx though). The difference is that an aggregate function collapses rows within the same group into one, whereas a windows function keeps all the rows within the same group/window, and add a new value to each row.</p>
<div id="2b4bda8c-a112-4942-8757-99f3db2f8d53" class="cell">
<pre class="sqlite cell-code"><code>select row_number() over(partition by visited_on), visited_on from customers</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">row_number() over(partition by visited_on)</td>
<td data-quarto-table-cell-role="th">visited_on</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-01</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2019-01-02</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-03</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2019-01-04</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-05</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2019-01-06</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-07</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2019-01-08</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-09</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2019-01-10</td>
</tr>
<tr class="even">
<td>2</td>
<td>2019-01-10</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>here <code>row_number()</code> is the windows function acting on the groups obtained from <code>partition by visited_on</code>.</p>
<p>We can use <code>order by</code> instead of <code>partition by</code>, in which case there is a single group, and the function is executed in the requested order.</p>
<div id="93c6f630-0c5c-4492-a69c-38cf2ca4a155" class="cell">
<pre class="sqlite cell-code"><code>select row_number() over(order by visited_on), visited_on from customers</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">row_number() over(order by visited_on)</td>
<td data-quarto-table-cell-role="th">visited_on</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2019-01-02</td>
</tr>
<tr class="even">
<td>3</td>
<td>2019-01-03</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2019-01-04</td>
</tr>
<tr class="even">
<td>5</td>
<td>2019-01-05</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2019-01-06</td>
</tr>
<tr class="even">
<td>7</td>
<td>2019-01-07</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2019-01-08</td>
</tr>
<tr class="even">
<td>9</td>
<td>2019-01-09</td>
</tr>
<tr class="odd">
<td>10</td>
<td>2019-01-10</td>
</tr>
<tr class="even">
<td>11</td>
<td>2019-01-10</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>it is possible to use both <code>partition by</code> and <code>order by</code> in <code>over()</code>.</p>
</section>
<section id="subquery-and-common-table-expression" class="level2">
<h2 class="anchored" data-anchor-id="subquery-and-common-table-expression">subquery and common table expression</h2>
<p>One can nest one query in another, called subquery. They are very useful in practice. Indeed, one complicated query needs to be decomposed into a few tasks. After figuring out the intermediate steps, one can put things together by either chaining them sequentially, or union, or a combination of both.</p>
<p>nested subqueries can be hard to read as the level of nested queries increases. this is where CTE comes into rescue. CTE is like defining intermediate variables in a general-purpose language such as python.</p>
<p>To illuastrate this, we consider three tables which are relational through ids.</p>
<div id="40f5cb6d-e8cb-45e9-bbe1-fd633f63257d" class="cell">
<pre class="sqlite cell-code"><code>select * from movies</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">movie_id</td>
<td data-quarto-table-cell-role="th">title</td>
</tr>
<tr class="even">
<td>1</td>
<td>Avengers</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Frozen 2</td>
</tr>
<tr class="even">
<td>3</td>
<td>Joker</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="57cd8cf3-113c-420b-a927-2733653ede1b" class="cell">
<pre class="sqlite cell-code"><code>select * from userss</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">user_id</td>
<td data-quarto-table-cell-role="th">name</td>
</tr>
<tr class="even">
<td>1</td>
<td>Daniel</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Monica</td>
</tr>
<tr class="even">
<td>3</td>
<td>Maria</td>
</tr>
<tr class="odd">
<td>4</td>
<td>James</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ff52f3f0-00c2-474b-9374-247d0b225d51" class="cell">
<pre class="sqlite cell-code"><code>select * from movierating</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">movie_id</td>
<td data-quarto-table-cell-role="th">user_id</td>
<td data-quarto-table-cell-role="th">rating</td>
<td data-quarto-table-cell-role="th">created_at</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>3</td>
<td>2020-01-12</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2</td>
<td>4</td>
<td>2020-02-11</td>
</tr>
<tr class="even">
<td>1</td>
<td>3</td>
<td>2</td>
<td>2020-02-12</td>
</tr>
<tr class="odd">
<td>1</td>
<td>4</td>
<td>1</td>
<td>2020-01-01</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>5</td>
<td>2020-02-17</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2</td>
<td>2</td>
<td>2020-02-01</td>
</tr>
<tr class="even">
<td>2</td>
<td>3</td>
<td>2</td>
<td>2020-03-01</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1</td>
<td>3</td>
<td>2020-02-22</td>
</tr>
<tr class="even">
<td>3</td>
<td>2</td>
<td>4</td>
<td>2020-02-25</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>first we <code>join</code> three tables (search online for all kinds of <code>join</code> methods!)</p>
<div id="ee68190b-7a10-4d0d-9e08-f5b3b14e1029" class="cell">
<pre class="sqlite cell-code"><code>select * from movierating left join userss using (user_id) left join movies using (movie_id)</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">movie_id</td>
<td data-quarto-table-cell-role="th">user_id</td>
<td data-quarto-table-cell-role="th">rating</td>
<td data-quarto-table-cell-role="th">created_at</td>
<td data-quarto-table-cell-role="th">name</td>
<td data-quarto-table-cell-role="th">title</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>3</td>
<td>2020-01-12</td>
<td>Daniel</td>
<td>Avengers</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2</td>
<td>4</td>
<td>2020-02-11</td>
<td>Monica</td>
<td>Avengers</td>
</tr>
<tr class="even">
<td>1</td>
<td>3</td>
<td>2</td>
<td>2020-02-12</td>
<td>Maria</td>
<td>Avengers</td>
</tr>
<tr class="odd">
<td>1</td>
<td>4</td>
<td>1</td>
<td>2020-01-01</td>
<td>James</td>
<td>Avengers</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>5</td>
<td>2020-02-17</td>
<td>Daniel</td>
<td>Frozen 2</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2</td>
<td>2</td>
<td>2020-02-01</td>
<td>Monica</td>
<td>Frozen 2</td>
</tr>
<tr class="even">
<td>2</td>
<td>3</td>
<td>2</td>
<td>2020-03-01</td>
<td>Maria</td>
<td>Frozen 2</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1</td>
<td>3</td>
<td>2020-02-22</td>
<td>Daniel</td>
<td>Joker</td>
</tr>
<tr class="even">
<td>3</td>
<td>2</td>
<td>4</td>
<td>2020-02-25</td>
<td>Monica</td>
<td>Joker</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>now we define <code>t</code> as the result of joining with CTE, then find the personâ€™s name who watched the largest number of movies, in case of a tie, choose the name that is lexicographical smaller (i.e.&nbsp;appears first in English dictionary). We would need the counts in order to find the name, this is where a subquery is required.</p>
<div id="8cd60b51-ee72-4281-8597-f26a09e8fbef" class="cell">
<pre class="sqlite cell-code"><code>-- CTE
with t as (
    select * from movierating left join userss using (user_id) left join movies using (movie_id)
)

select name as results from (
    -- subquery
    select name, count(*) cnt from t group by user_id, name order by cnt desc, name 
) 
limit 1</code></pre>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">results</td>
</tr>
<tr class="even">
<td>Daniel</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">next steps</h2>
<p>writing efficient SQL is a matter of practice. In the <code>sql</code> directory of this <a href="https://github.com/xiaochuany/algorithms">repo</a>, you can find the solution to 50 exercises collected from leetcode. They cover a wide range of problems, including what weâ€™ve covered in this post and date operations, regular expressionsâ€¦ have fun learning SQL!</p>


</section>

 ]]></description>
  <category>data engineering</category>
  <guid>https://xiaochuany.github.io/1principle/posts/gist/sql101.html</guid>
  <pubDate>Sat, 27 Jan 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>What is required to achieve a top 20% ranking in Kaggle playground series</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/gist/top-fifth-kaggle.html</link>
  <description><![CDATA[ 





<p>The playground series is devoted to tabular datasets and are the most accessible competitions for beginners to learn and develop skills. This blog/notebook is to showcase some streamlined approach to achieve a relatively good performance. The notebook is written for Kaggle playground series season 3 episode 26 (last one in 2023). At the time of writing this blog, the submission achieves 149/871 (top 18%) ranking. <code>final ranking private leaderboard: 332/1663 (top 20%)</code></p>
<p>Outline:</p>
<ul>
<li>use <code>fastkaggle</code> module to quickly set up the competition (download and unzip data) and submit it later.</li>
<li>preprocess data: add additional dataset offered by the competition owner</li>
<li>modelling: compute cv score of
<ul>
<li>base models: logistic regression, random forest (not supporting <code>np.nan</code>)</li>
<li>gradient boosting: hist gradient boosting, light gbm, xgboost</li>
</ul></li>
<li>cross validate the best model (lgbm), return classifiers and average out the predictions on test data.</li>
</ul>
<div id="732f09f4" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install fastkaggle if not available</span></span>
<span id="cb1-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fastkaggle</span>
<span id="cb1-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ModuleNotFoundError</span>:</span>
<span id="cb1-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uq fastkaggle</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastkaggle <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span></code></pre></div>
</div>
<section id="getting-set-up" class="level2">
<h2 class="anchored" data-anchor-id="getting-set-up">Getting set up</h2>
<div id="70f2d75c" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">comp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'playground-series-s3e26'</span></span>
<span id="cb2-2">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> setup_comp(comp, install<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading playground-series-s3e26.zip to /home/xy/git/1principle/posts/gist</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 350k/350k [00:00&lt;00:00, 1.56MB/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<div id="879f9000" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">path</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>Path('playground-series-s3e26')</code></pre>
</div>
</div>
<div id="1c8e2512" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb9-2"></span>
<span id="cb9-3">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span></span>
<span id="cb9-4">trn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(trn_path)</span>
<span id="cb9-5">trn.info()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 7905 entries, 0 to 7904
Data columns (total 20 columns):
 #   Column         Non-Null Count  Dtype  
---  ------         --------------  -----  
 0   id             7905 non-null   int64  
 1   N_Days         7905 non-null   int64  
 2   Drug           7905 non-null   object 
 3   Age            7905 non-null   int64  
 4   Sex            7905 non-null   object 
 5   Ascites        7905 non-null   object 
 6   Hepatomegaly   7905 non-null   object 
 7   Spiders        7905 non-null   object 
 8   Edema          7905 non-null   object 
 9   Bilirubin      7905 non-null   float64
 10  Cholesterol    7905 non-null   float64
 11  Albumin        7905 non-null   float64
 12  Copper         7905 non-null   float64
 13  Alk_Phos       7905 non-null   float64
 14  SGOT           7905 non-null   float64
 15  Tryglicerides  7905 non-null   float64
 16  Platelets      7905 non-null   float64
 17  Prothrombin    7905 non-null   float64
 18  Stage          7905 non-null   float64
 19  Status         7905 non-null   object 
dtypes: float64(10), int64(3), object(7)
memory usage: 1.2+ MB</code></pre>
</div>
</div>
</section>
<section id="preprocessing-data" class="level2">
<h2 class="anchored" data-anchor-id="preprocessing-data">Preprocessing data</h2>
<div id="199ddfda-36a7-4c1e-92b9-4da9370ebe4d" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">get_dataset(path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'joebeachcapital/cirrhosis-patient-survival-prediction'</span>, force<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># filename= cirrhosis.csv</span></span></code></pre></div>
</div>
<div id="293552a4-dca8-4d23-a02b-29ed926bd31c" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> preprocess(df, train<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dropna<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb12-2">    df_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.copy()</span>
<span id="cb12-3">    df_[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_gen'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span></span>
<span id="cb12-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> train:</span>
<span id="cb12-5">        df1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cirrhosis.csv'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># original data based on which the dataset is synthesized</span></span>
<span id="cb12-6">        df1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([df1.drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), df1[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>]], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># move status to last col, same as df_</span></span>
<span id="cb12-7">        df1[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_gen'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N'</span></span>
<span id="cb12-8">        df1.columns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_.columns</span>
<span id="cb12-9">        df_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([df_,df1], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).reset_index(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb12-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dropna: df_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_.dropna()</span>
<span id="cb12-11">        df_[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_.Status.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CL'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>})</span>
<span id="cb12-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df_</span></code></pre></div>
</div>
</section>
<section id="modelling" class="level2">
<h2 class="anchored" data-anchor-id="modelling">Modelling</h2>
<div id="53eef354-27a0-4f22-8ded-70b3e8ff0df2" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StandardScaler,OneHotEncoder,PowerTransformer,LabelEncoder</span>
<span id="cb13-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.compose <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_column_transformer, make_column_selector</span>
<span id="cb13-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.pipeline <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_pipeline</span>
<span id="cb13-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split, RandomizedSearchCV, StratifiedKFold, cross_val_score, cross_validate, KFold</span>
<span id="cb13-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.ensemble <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HistGradientBoostingRegressor, HistGradientBoostingClassifier, RandomForestClassifier</span>
<span id="cb13-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_scorer, mean_absolute_error, classification_report, log_loss</span>
<span id="cb13-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.linear_model <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LogisticRegression</span>
<span id="cb13-9"></span>
<span id="cb13-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> loguniform</span>
<span id="cb13-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lightgbm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LGBMRegressor, LGBMClassifier</span>
<span id="cb13-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> xgboost <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> XGBRegressor, XGBClassifier</span>
<span id="cb13-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb13-14"></span>
<span id="cb13-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb13-16">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span></code></pre></div>
</div>
<section id="models-not-supporting-nan" class="level3">
<h3 class="anchored" data-anchor-id="models-not-supporting-nan">models not supporting nan</h3>
<div id="b8591976-2dba-4970-b929-c276b66607eb" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> preprocess(pd.read_csv(trn_path),train<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dropna<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb14-2">X, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).iloc[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>]</span></code></pre></div>
</div>
<div id="ad3d4662-b9f8-46cf-af65-242828e6f9fa" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_column_transformer(</span>
<span id="cb15-2">                (PowerTransformer(), make_column_selector(dtype_include <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.number)),</span>
<span id="cb15-3">                (OneHotEncoder(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'if_binary'</span>, handle_unknown<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>), make_column_selector(dtype_include<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">object</span>)), </span>
<span id="cb15-4">                remainder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passthrough'</span>)</span></code></pre></div>
</div>
<div id="d6e54ad7-cce2-4955-afe5-79c439a57d66" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb16-2">logit_cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cross_val_score(</span>
<span id="cb16-3">    make_pipeline(ct, LogisticRegression(max_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)),</span>
<span id="cb16-4">    X,y, scoring <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'neg_log_loss'</span>, cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, n_jobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'logitstic regression </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>logit_cv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/xy/miniforge3/lib/python3.10/site-packages/sklearn/preprocessing/_encoders.py:228: UserWarning: Found unknown categories in columns [6] during transform. These unknown categories will be encoded as all zeros
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>logitstic regression -logit_cv.mean()=0.5110572273752632
CPU times: user 92.2 ms, sys: 20.3 ms, total: 113 ms
Wall time: 1.05 s</code></pre>
</div>
</div>
<div id="92de18f8-346b-4cf3-8f73-a5da9f05cef2" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb19-2">RF_cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cross_val_score(make_pipeline(ct, RandomForestClassifier(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_estimators'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb19-3">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'criterion'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log_loss'</span>,</span>
<span id="cb19-4">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_depth'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>,</span>
<span id="cb19-5">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_samples_split'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb19-6">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_samples_leaf'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb19-7">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_features'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb19-8">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'random_state'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb19-9">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_jobs'</span>: <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})),</span>
<span id="cb19-10">                        X, y, scoring <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'neg_log_loss'</span>, cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, n_jobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"random forrest </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>RF_cv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>random forrest -RF_cv.mean()=0.44559989137605854
CPU times: user 2min 23s, sys: 33.3 s, total: 2min 56s
Wall time: 48.5 s</code></pre>
</div>
</div>
</section>
<section id="models-supporting-nan" class="level3">
<h3 class="anchored" data-anchor-id="models-supporting-nan">models supporting nan</h3>
<div id="79d86bf0-fa85-4166-a09e-1624dfa7f5e7" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> preprocess(pd.read_csv(trn_path),train<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dropna<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb21-2">X, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).iloc[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Status'</span>]</span></code></pre></div>
</div>
<div id="9d07267b-8dd3-495b-a7af-04c664df6e6b" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb22-2">HB_cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cross_val_score(make_pipeline(ct, HistGradientBoostingClassifier(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l2_regularization'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.876168706639714</span>,</span>
<span id="cb22-3">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'early_stopping'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb22-4">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'learning_rate'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.009956485590638034</span>,</span>
<span id="cb22-5">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_iter'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>,</span>
<span id="cb22-6">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_depth'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb22-7">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_bins'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>,</span>
<span id="cb22-8">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_samples_leaf'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb22-9">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_leaf_nodes'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,</span>
<span id="cb22-10">                                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'random_state'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>})),</span>
<span id="cb22-11">                        X, y, scoring <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'neg_log_loss'</span>, cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, n_jobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb22-12"></span>
<span id="cb22-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"histGB </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>HB_cv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/xy/miniforge3/lib/python3.10/site-packages/sklearn/preprocessing/_encoders.py:228: UserWarning: Found unknown categories in columns [0, 2, 3, 4, 6] during transform. These unknown categories will be encoded as all zeros
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>histGB -HB_cv.mean()=0.43771002014457927
CPU times: user 162 ms, sys: 118 ms, total: 281 ms
Wall time: 15.5 s</code></pre>
</div>
</div>
<div id="0afdfb88-9a33-444d-b9f5-b3b6055fd93a" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb25-2">LGBM_cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cross_val_score(make_pipeline(ct,LGBMClassifier(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_estimators'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb25-3">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'learning_rate'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.013657589160895923</span>,</span>
<span id="cb25-4">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_depth'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>,</span>
<span id="cb25-5">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reg_alpha'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.9791969860931342</span>,</span>
<span id="cb25-6">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reg_lambda'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2857088172765347</span>,</span>
<span id="cb25-7">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_leaves'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">37</span>,</span>
<span id="cb25-8">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subsample'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6351453342675659</span>,</span>
<span id="cb25-9">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'colsample_bytree'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2644509924064132</span>})),</span>
<span id="cb25-10">                          X, y, scoring <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'neg_log_loss'</span>, cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, n_jobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div id="0a4ee7b2-5c1f-492c-8b38-ca1ab7b950ad" class="cell" data-scrolled="true" data-execution_count="44">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Light GBM  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>LGBM_cv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Light GBM  -LGBM_cv.mean()=0.42275781396747264</code></pre>
</div>
</div>
<div id="60e3d83f-2f18-45a9-b66c-3a84581f1392" class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb28-2">XGB_cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cross_val_score(make_pipeline(ct, XGBClassifier(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_depth'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb28-3">                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'learning_rate'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03570188608151033</span>,</span>
<span id="cb28-4">                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_estimators'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb28-5">                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6440001307764849</span>,</span>
<span id="cb28-6">                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_child_weight'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb28-7">                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'colsample_bytree'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.27034458854562116</span>,</span>
<span id="cb28-8">                                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subsample'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8435412915999765</span>})), </span>
<span id="cb28-9">                          X, y, scoring <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'neg_log_loss'</span>, cv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, n_jobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div id="d60a58b8-777a-482e-9516-1198e8d0edce" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"XGBoost </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>XGB_cv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>XGBoost -XGB_cv.mean()=0.42872410511564896</code></pre>
</div>
</div>
<div id="bca6b1cb-c469-4743-94bd-1b1a0b72d7f5" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cv(X,y,cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb31-2">    clf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LGBMClassifier(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_estimators'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb31-3">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'learning_rate'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.013657589160895923</span>,</span>
<span id="cb31-4">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_depth'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>,</span>
<span id="cb31-5">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reg_alpha'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.9791969860931342</span>,</span>
<span id="cb31-6">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reg_lambda'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2857088172765347</span>,</span>
<span id="cb31-7">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_leaves'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">37</span>,</span>
<span id="cb31-8">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subsample'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6351453342675659</span>,</span>
<span id="cb31-9">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'colsample_bytree'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2644509924064132</span>})</span>
<span id="cb31-10">    ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_column_transformer(</span>
<span id="cb31-11">                (PowerTransformer(), make_column_selector(dtype_include <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.number)),</span>
<span id="cb31-12">                (OneHotEncoder(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'if_binary'</span>, handle_unknown<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>), make_column_selector(dtype_include<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">object</span>)), </span>
<span id="cb31-13">                remainder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passthrough'</span>)</span>
<span id="cb31-14">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_pipeline(ct, clf)</span>
<span id="cb31-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cross_validate(model, X, y, cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cv, scoring<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'neg_log_loss'</span>, return_estimator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, n_jobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div id="36b9ab8d-ca32-48e6-8dcd-89df62739e27" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb32-2">cv_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv(X,y,cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
</div>
<div id="41c1ddd0-075c-480e-a5d2-a12d863611e7" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>cv_output[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test_score'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cv_output[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test_score'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>std()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-cv_output['test_score'].mean()=0.4206909352553819, cv_output['test_score'].std()=0.04075158479629894</code></pre>
</div>
</div>
</section>
</section>
<section id="submitting-to-kaggle" class="level2">
<h2 class="anchored" data-anchor-id="submitting-to-kaggle">Submitting to Kaggle</h2>
<div id="55cd25e5" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">ss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>)</span>
<span id="cb35-2">ss.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">Status_C</th>
<th data-quarto-table-cell-role="th">Status_CL</th>
<th data-quarto-table-cell-role="th">Status_D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7905</td>
<td>0.628084</td>
<td>0.034788</td>
<td>0.337128</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7906</td>
<td>0.628084</td>
<td>0.034788</td>
<td>0.337128</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>7907</td>
<td>0.628084</td>
<td>0.034788</td>
<td>0.337128</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7908</td>
<td>0.628084</td>
<td>0.034788</td>
<td>0.337128</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7909</td>
<td>0.628084</td>
<td>0.034788</td>
<td>0.337128</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="266c32e1-a7cc-43b7-ac8b-cc0a8a5c8fa4" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">tst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> preprocess(pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>), train<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb36-2">tst.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">N_Days</th>
<th data-quarto-table-cell-role="th">Drug</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Ascites</th>
<th data-quarto-table-cell-role="th">Hepatomegaly</th>
<th data-quarto-table-cell-role="th">Spiders</th>
<th data-quarto-table-cell-role="th">Edema</th>
<th data-quarto-table-cell-role="th">Bilirubin</th>
<th data-quarto-table-cell-role="th">Cholesterol</th>
<th data-quarto-table-cell-role="th">Albumin</th>
<th data-quarto-table-cell-role="th">Copper</th>
<th data-quarto-table-cell-role="th">Alk_Phos</th>
<th data-quarto-table-cell-role="th">SGOT</th>
<th data-quarto-table-cell-role="th">Tryglicerides</th>
<th data-quarto-table-cell-role="th">Platelets</th>
<th data-quarto-table-cell-role="th">Prothrombin</th>
<th data-quarto-table-cell-role="th">Stage</th>
<th data-quarto-table-cell-role="th">is_gen</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7905</td>
<td>3839</td>
<td>D-penicillamine</td>
<td>19724</td>
<td>F</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>1.2</td>
<td>546.0</td>
<td>3.37</td>
<td>65.0</td>
<td>1636.0</td>
<td>151.90</td>
<td>90.0</td>
<td>430.0</td>
<td>10.6</td>
<td>2.0</td>
<td>Y</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7906</td>
<td>2468</td>
<td>D-penicillamine</td>
<td>14975</td>
<td>F</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>1.1</td>
<td>660.0</td>
<td>4.22</td>
<td>94.0</td>
<td>1257.0</td>
<td>151.90</td>
<td>155.0</td>
<td>227.0</td>
<td>10.0</td>
<td>2.0</td>
<td>Y</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>7907</td>
<td>51</td>
<td>Placebo</td>
<td>13149</td>
<td>F</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>2.0</td>
<td>151.0</td>
<td>2.96</td>
<td>46.0</td>
<td>961.0</td>
<td>69.75</td>
<td>101.0</td>
<td>213.0</td>
<td>13.0</td>
<td>4.0</td>
<td>Y</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7908</td>
<td>2330</td>
<td>D-penicillamine</td>
<td>20510</td>
<td>F</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>0.6</td>
<td>293.0</td>
<td>3.85</td>
<td>40.0</td>
<td>554.0</td>
<td>125.55</td>
<td>56.0</td>
<td>270.0</td>
<td>10.6</td>
<td>2.0</td>
<td>Y</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7909</td>
<td>1615</td>
<td>D-penicillamine</td>
<td>21904</td>
<td>F</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>1.4</td>
<td>277.0</td>
<td>2.97</td>
<td>121.0</td>
<td>1110.0</td>
<td>125.00</td>
<td>126.0</td>
<td>221.0</td>
<td>9.8</td>
<td>1.0</td>
<td>Y</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="48406c30-8f65-41e2-89d9-b7d888179b45" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">tst_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack([est.predict_proba(tst.iloc[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> est <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cv_output[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'estimator'</span>]]).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</div>
<div id="e91d57bd-d75a-4936-a374-6ec7f1a4611d" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">ss.iloc[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_pred</span></code></pre></div>
</div>
<div id="35172dac-97be-425c-b3db-a73e7950e2d2" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">ss.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subm.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb39-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head subm.csv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>id,Status_C,Status_CL,Status_D
7905,0.3034480206600728,0.02175049687406757,0.6748014824658597
7906,0.464722990035046,0.17105995489987008,0.3642170550650838
7907,0.034054616093133115,0.011479074721858778,0.954466309185008
7908,0.9778662946803056,0.002733559845527006,0.01940014547416722
7909,0.8730251010963693,0.042703149687327954,0.08427174921630272
7910,0.9909153131787145,0.0011266786376778267,0.007958008183607803
7911,0.9843376622366685,0.0014776242979965683,0.014184713465334847
7912,0.0945863204842192,0.026772389955302976,0.8786412895604778
7913,0.009370330198415863,0.0019239529424342871,0.98870571685915</code></pre>
</div>
</div>
<div id="ed52342c" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> iskaggle:</span>
<span id="cb41-2">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> kaggle <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> api</span>
<span id="cb41-3">    api.competition_submit_cli(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subm.csv'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lgbm 10fold avg'</span>, comp)</span></code></pre></div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The hypterparameters for each model should be found before hand with e.g.&nbsp;<code>optuna</code>. Here we copy those from this excellent <a href="https://github.com/oscarm524/Kaggle_Notebooks/blob/0ed35829e79eb1d7a37ed4410072c738008ee042/ps-s3-ep26-eda-modeling-submission.ipynb">notebook</a>. Note however that the ensemble method adopted here is less sophisticated than the said notebook, the purpose of which is to reach a reasonable place faster.</p>
<p>Apart from careful ensemble (such as weighted average), it would be useful to exploit/create more predictive features. Some domain knowledge might come in handy.</p>
<p>A different direction is to replace tree-based models by neural nets. This is worth another post and hopefully I will come back to it soon.</p>


</section>

 ]]></description>
  <category>kaggle</category>
  <category>python</category>
  <category>machine learning</category>
  <guid>https://xiaochuany.github.io/1principle/posts/gist/top-fifth-kaggle.html</guid>
  <pubDate>Sat, 16 Dec 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>bits of fastai live-coding sessions</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/gist/walkthrough.html</link>
  <description><![CDATA[ 





<p>Jeremy Howard, the founder of fastai, organized a series of live coding sessions covering the basics of git, bash, vim, tmux, and more, as a companion to the free fastai course on deep learning. Here is the <a href="https://www.youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM">playlist</a> and the <a href="https://forums.fast.ai/t/live-coding-aka-walk-thrus/96617">forum post</a>.</p>
<section id="live-coding-1" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-1">Live coding 1</h2>
<ul>
<li>intall WSL if on Windows (all commands below are typed in linux terminal in WSL)</li>
<li><code>alt + enter</code> for full screen</li>
<li><code>pwd</code> print working directory</li>
<li><code>which</code> shows where a file is</li>
<li><code>mkdir</code> makes a directory</li>
<li><code>ls</code> list stuffs <code>-lah</code> long format all files human readable</li>
<li><code>df -h</code> disk free</li>
<li><code>du -sh *</code> disk usage <code>-s</code> summary of all subdirectories in <code>.</code></li>
<li><code>du -sh .</code> disk usage of <code>.</code><br>
</li>
<li><a href="https://github.com/conda-forge/miniforge">conda-forge distribution</a> as of september 2023, mambaforge/miniforge3 are the same. <code>-c conda-forge</code> is the default</li>
<li><code>wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh</code> to download the distribution</li>
<li><code>bash Miniforge3-Linux-x86_64.sh -b</code> to install, where <code>-b</code> for less intervention</li>
<li>install pytorch <a href="https://pytorch.org/get-started/locally/">here</a></li>
<li><code>mamba install jupyter ipywidgets</code></li>
<li><code>alias jl="jupyter lab"</code> add this command to the end of <code>.bashrc</code> to save alias for good</li>
<li><code>mamba install -c fastai fastai</code></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Jeremy automated setup of conda in this <a href="https://raw.githubusercontent.com/fastai/fastsetup/master/setup-conda.sh">file</a>. To run it, one needs to add executable permission to user <code>chmod u+x setup-conda.sh</code></p>
</div>
</div>
</section>
<section id="live-coding-2" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-2">Live coding 2</h2>
<section id="bash" class="level4">
<h4 class="anchored" data-anchor-id="bash">bash</h4>
<ul>
<li><code>cd -</code> back to most recent directory</li>
<li><code>pushd ~</code> push current directory to a stack and change directory to <code>~</code></li>
<li><code>popd</code> pop whatâ€™s in the stack</li>
<li><code>ctrl+d</code> exit for most program</li>
<li><code>ctrl+u</code> <code>ctrl+w</code> <code>ctrl+a</code> <code>ctrl+e</code> move cursor faster</li>
</ul>
</section>
<section id="tmux" class="level4">
<h4 class="anchored" data-anchor-id="tmux">tmux</h4>
<ul>
<li><code>tmux</code></li>
<li><code>ctrl+b</code> start of a tmux command, then</li>
<li><code>"</code> split top-bottom</li>
<li><code>%</code> split left-right</li>
<li><code>z</code> zoom in/out</li>
<li><code>d</code> detach, back to bash</li>
<li><code>tmux a</code> attach stuffs running in tmux from bash (everything remains until restart computer)</li>
</ul>
</section>
<section id="git-with-ssh" class="level4">
<h4 class="anchored" data-anchor-id="git-with-ssh">git (with ssh)</h4>
<ul>
<li><code>ssh-keygen</code> generates public/private rsa key pair (prompt where to save the file, by default itâ€™s in <code>~/.ssh</code>)</li>
<li>login to github.com and upload public key <code>cat ~/.ssh/id_rsa.pub</code></li>
<li><code>git clone git@github.com:fastai/fastbook.git</code></li>
<li><code>git status</code></li>
<li><code>git commit -am 'MESSAGE'</code></li>
<li><code>git push</code></li>
</ul>
</section>
</section>
<section id="live-coding-3" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-3">Live coding 3</h2>
<section id="bash-1" class="level4">
<h4 class="anchored" data-anchor-id="bash-1">bash</h4>
<ul>
<li><code>ln -s ONE</code> simlink ONE to here</li>
<li><code>$PATH</code> paths that bash knows to run program</li>
</ul>
</section>
<section id="paperspace" class="level4">
<h4 class="anchored" data-anchor-id="paperspace">paperspace</h4>
<ul>
<li><code>pip install --user PACKAGE</code> will install PACKAGE to <code>~/.local/lib/python3.*/site-packages</code> which gets wiped after shutdown</li>
<li><code>mv ~/.local /storage/.local</code> then</li>
<li><code>ln -s /storage/.local ~/</code> to make it persistent (<code>/storage</code> is persistent across notebook instances)</li>
</ul>
</section>
<section id="jupyter-lab" class="level4">
<h4 class="anchored" data-anchor-id="jupyter-lab">jupyter lab</h4>
<ul>
<li><code>ctrl + shift + [</code> change tab</li>
<li><code>ctrl + b</code> hide side column</li>
<li><code>%%debug</code> exit with <code>q</code></li>
<li><code>shift + tab</code> or <code>METHOD?</code> shows signature</li>
<li><code>METHOD??</code> shows source code</li>
</ul>
</section>
</section>
<section id="live-coding-4" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-4">Live coding 4</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Jeremy teaches how to write your first bash script. The job done via these scripts is to set up paperspace for persistent storage and configs across instances. The repo is <a href="https://github.com/fastai/paperspace-setup/tree/master">here</a>.</p>
</div>
</div>
<section id="first-script-pre-run.sh" class="level3">
<h3 class="anchored" data-anchor-id="first-script-pre-run.sh">first script <code>pre-run.sh</code></h3>
<pre class="{bash}"><code>#!/usr/bin/env bash

pushd ~

mkdir -p /storage/cfg

if [ ! -e /storage/cfg/.conda ]; then
        mamba create -yp /storage/cfg/.conda
fi

for p in .local .ssh .config .ipython .fastai .jupyter .conda .kaggle
do
        if [ ! -e /storage/cfg/$p ]; then
                mkdir /storage/cfg/$p
        fi
        rm -rf ~/$p
        ln -s /storage/cfg/$p ~/
done

chmod 700 /storage/cfg/.ssh

for p in .git-credentials .gitconfig .bash_history
do
        if [ ! -e /storage/cfg/$p ]; then
                touch /storage/cfg/$p
        fi
        rm -rf ~/$p
        ln -s /storage/cfg/$p ~/
done

popd</code></pre>
</section>
<section id="second-script-setup.sh" class="level3">
<h3 class="anchored" data-anchor-id="second-script-setup.sh">second script <code>setup.sh</code></h3>
<pre class="{bash}"><code>#!/usr/bin/env bash

mkdir /storage/cfg
cp pre-run.sh /storage/
cp .bash.local /storage/
echo install complete. please start a new instance</code></pre>
</section>
</section>
<section id="live-coding-5" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-5">Live coding 5</h2>
<section id="bash-2" class="level4">
<h4 class="anchored" data-anchor-id="bash-2">bash</h4>
<ul>
<li><code>cat FILE</code> display file</li>
<li><code>cat f1 f2 &gt; combined</code> concat</li>
<li><code>cat f1 &gt;&gt; f2</code> append</li>
</ul>
</section>
<section id="vim" class="level4">
<h4 class="anchored" data-anchor-id="vim">vim</h4>
<ul>
<li><code>i</code> insert mode</li>
<li><code>esc</code> back to command mode</li>
<li>in command mode try <code>:q</code> to quit <code>:wq</code> to write and quit</li>
<li>tutorial <a href="https://vim-adventures.com/">https://vim-adventures.com/</a></li>
</ul>
<p>alternatively, type <code>code .</code> then edit/create file with VS code</p>
</section>
</section>
<section id="live-coding-6" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-6">Live coding 6</h2>
<ul>
<li><code>du -sh * | grep 'G'</code> search ouput of <code>du -sh *</code> that contains <code>G</code> to identify directories larger than GB</li>
<li><code>conda install universal-ctags</code></li>
<li>copy config files to Paperspace (theyâ€™ll be persistent if weâ€™ve run the bash script before in live coding 4.)
<ul>
<li>copy ssh keys to <code>~/.ssh</code> and change permissions <code>chmod 644 ~/.ssh/id_rsa.pub</code> <code>chmod 600 ~/.ssh/id_rsa</code></li>
<li>first time git commit needs <code>~/.gitconfig</code> to have name and email of the user, just follow the prompt.</li>
</ul></li>
</ul>
</section>
<section id="live-coding-7" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-7">Live coding 7</h2>
<ul>
<li><code>pip isntall --user kaggle</code><br>
</li>
<li>pre-append <code>~/.bashrc</code> with <code>export PATH=~/.local/bin:$PATH</code></li>
<li><code>source .bashrc</code></li>
<li>create <code>kaggle.json</code> file from kaggle website and copy it into <code>~/.kaggle</code></li>
<li>navigate into <code>.kaggle</code> and <code>chmod 600 kaggle.json</code></li>
<li><code>kaggle competitions donwnload -c NAME</code></li>
</ul>
<p>Try <code>time unzip -q BLA</code> to see how long it takes to unzip.</p>
<ul>
<li><code>nvidia-smi dmon</code> if sm is low, this means i/o slow. Try
<ul>
<li>resize image</li>
<li>move files to local (see <code>get_data.sh</code> below)</li>
<li>reduce augmentation</li>
<li>change to CPU instance?</li>
</ul></li>
</ul>
<p>On paperspace, create <code>get_data.sh</code> in <code>/notebooks</code> (persistent)</p>
<pre class="{bash}"><code>#!/user/bin/env bash
cd
mkdir BLA
cd BLA
kaggle competitions donwnload -c NAME
unzip -q NAME</code></pre>


</section>

 ]]></description>
  <category>hacks</category>
  <guid>https://xiaochuany.github.io/1principle/posts/gist/walkthrough.html</guid>
  <pubDate>Sat, 11 Nov 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Machine Learning Recap 1 Concepts</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/deep-dive/uml-recap1.html</link>
  <description><![CDATA[ 





<section id="setting-up-the-scene" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-scene">Setting up the scene</h2>
<p>In a supervised learning, we specify</p>
<ul>
<li>an example space <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%20X"><br>
</li>
<li>a label space <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%20Y"></li>
<li>a collection of hypotheses <img src="https://latex.codecogs.com/png.latex?h:%20%5Cmathcal%20X%20%5Cto%20%5Cmathcal%20Y">, making up the hypothesis class (inductive bias), from which we want to pick a predictor</li>
<li>a loss function <img src="https://latex.codecogs.com/png.latex?%5Cell:%20%5Cmathcal%20Y%20%5Ctimes%20%5Cmathcal%20Y%20%5Cto%20%5Cmathbb%7BR%7D_+">, quantifying how good or bad a prediction <img src="https://latex.codecogs.com/png.latex?%5Chat%20y"> is compared to the ground truth label <img src="https://latex.codecogs.com/png.latex?y"></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are given an independent and identically distributed input-output pairs <img src="https://latex.codecogs.com/png.latex?S%20=%20%5C%7B(x_i,y_i),%20i=%5Bm%5D%5C%7D%5Csubset%20%5Cmathcal%20X%5Ctimes%5Cmathcal%20Y"> with distribution <img src="https://latex.codecogs.com/png.latex?D">.</p>
</div>
</div>
<p>Our goal is to pick the â€œbestâ€ predictor in the sense of minimising the true loss<br>
<img src="https://latex.codecogs.com/png.latex?%0AL_D(h)%20=%20%5Cmathbb%7BE%7D_%7B(x,y)%5Csim%20D%7D%5B%5Cell(h(x),y))%5D%20%20%0A"> where <img src="https://latex.codecogs.com/png.latex?D"> is the <em>true</em> distribution of <img src="https://latex.codecogs.com/png.latex?(x,y)">.</p>
<p>Obviously <em>a priori</em> the distribution <img src="https://latex.codecogs.com/png.latex?D"> of the samples is unkonwn. However by law of large numbers we know that <img src="https://latex.codecogs.com/png.latex?%0AL_S(h):=%20%5Cfrac%7B1%7D%7Bm%7D%5Csum_%7Bi=1%7D%5Em%20%5Cell(h(x_i),y_i)%0A"> is a consistent estimator of <img src="https://latex.codecogs.com/png.latex?L_D(h)"> (when <img src="https://latex.codecogs.com/png.latex?m%5Cto%5Cinfty"> under mild condition on the distribution of <img src="https://latex.codecogs.com/png.latex?%5Cell(h(x),y)">). This motivates the empirical risk minimisation (ERM) approach i.e.&nbsp;we look for <img src="https://latex.codecogs.com/png.latex?%0Ah_S%20%5Cin%20%5Cmathrm%7Bargmin%7D_%7Bh%5Cin%5Cmathcal%20H%7D%20L_S(h)%0A"> Hence, instead of minimising the true risk, we minimise the empirical risk, which is close to the true risk when <img src="https://latex.codecogs.com/png.latex?m"> is large, for a fixed <img src="https://latex.codecogs.com/png.latex?h">. Whether such approximation is valid uniformly for all the hypothesis in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%20H">, in other words, whether <img src="https://latex.codecogs.com/png.latex?h_S%5Capprox%20h%5E*%5Cin%20%5Cmathrm%7Bargmin%7D_%7Bh%5Cin%5Cmathcal%20H%7D%20L_D(h)">, is at the centre of the so-called learning theory.</p>
<p>We often decompose the generalisation error <img src="https://latex.codecogs.com/png.latex?L_D(h_S)"> in two parts: <img src="https://latex.codecogs.com/png.latex?%0AL_D(h_S)%20=%20%20L_D(h%5E*)%20+%20%5BL_D(h_S)%20-%20L_D(h%5E*)%5D%0A"> the first is called the approximation error, and second estimation error.</p>
</section>
<section id="lets-be-concrete" class="level2">
<h2 class="anchored" data-anchor-id="lets-be-concrete">Letâ€™s be concrete</h2>
<p>From a practical point of view, we may not want to get into the learning theory bounds despite its elegance, what we do is to split the sample <img src="https://latex.codecogs.com/png.latex?S%5E0"> into two parts <img src="https://latex.codecogs.com/png.latex?S,%20V">, where <img src="https://latex.codecogs.com/png.latex?S"> is used to find an ERM which we denote by <img src="https://latex.codecogs.com/png.latex?h_S">, another for testing whether the found ERM achieves small <img src="https://latex.codecogs.com/png.latex?L_D(h_S)">. The rationale is simple, since we make iid assumption, <img src="https://latex.codecogs.com/png.latex?V"> is independent of <img src="https://latex.codecogs.com/png.latex?S">, hence <img src="https://latex.codecogs.com/png.latex?L_%7BV%7D(h_S)%20%5Capprox%20L_D(h_S)"> when <img src="https://latex.codecogs.com/png.latex?%7CV%7C"> is not too small. Therefore, the smallness of <img src="https://latex.codecogs.com/png.latex?L_%7BV%7D(h_S)"> indicates good quality (small true risk) of our predictor <img src="https://latex.codecogs.com/png.latex?h_1">.</p>
<p>The split method for arrays is implemented in <code>sklearn.model_selection</code></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb1-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,))</span>
<span id="cb1-5">x_tr, x_te <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(x,test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span></code></pre></div>
</div>
<p>Typically, examples are vectors in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ed,%20d%5Cge%201">. In <img src="https://latex.codecogs.com/png.latex?k">-way (<img src="https://latex.codecogs.com/png.latex?k%5Cge%202">) classification problems, labels are one-hot encodings <img src="https://latex.codecogs.com/png.latex?e_1,...,%20e_k"> where <img src="https://latex.codecogs.com/png.latex?e_i"> is the unit vector in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ek"> with one on the <img src="https://latex.codecogs.com/png.latex?i"> th coordinate and zero elsewhere. If <img src="https://latex.codecogs.com/png.latex?k=2">, we can drop the second coordinate and simply denote the two classes by <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%20-1%5C%7D"> or <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1%5C%7D">. In regression problems, the labels are in the continuum <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ek,%20k%5Cge%201">.</p>
<p>Now consider <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%20H">. For classification problems, instead of predicting discrete class labels directly, it is sometimes beneficial to predict a probability mass function over the <img src="https://latex.codecogs.com/png.latex?k"> classes. From the pmf, a label can be obtained by taking argmax. In other words, the range of <img src="https://latex.codecogs.com/png.latex?h%5Cin%5Cmathcal%20H"> is assumed to be <img src="https://latex.codecogs.com/png.latex?%5C%7By%5Cin%5Cmathbb%7BR%7D%5Ek:%20y_i%5Cge%200,%20y_1+...+y_k=1%5C%7D">. For regression problems there are no such constraints and the range can be the whole <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ek">.</p>
<p>The choie of the loss function may vary, depending on what goal we are trying to achiecve. Researchers can design new losses suitable for their use case. Here we mention a few popular ones. For classification problems, if we use hypothesis predicting pmf, the cross entropy loss is often a good choice <img src="https://latex.codecogs.com/png.latex?%0AXE(p,%5Chat%20p)%20=%20%20-%20%5Csum_%7Bi=1%7D%5Ek%20p_i%20%5Clog(%5Chat%20p_i)%0A"> For regression problems, the squared loss is often a good choice <img src="https://latex.codecogs.com/png.latex?SE(y,%5Chat%20y)=%20%5C%7Cy-%5Chat%20y%5C%7C%5E2_2"> where <img src="https://latex.codecogs.com/png.latex?%5C%7C.%5C%7C"> is Euclidean norm.</p>
<p>One of the advantages of these loss functions is that they are convex in the <img src="https://latex.codecogs.com/png.latex?%5Chat%20p"> or <img src="https://latex.codecogs.com/png.latex?%5Chat%20y"> variables, making it possible to leverage the machinery of convex optimistion when it comes to the actual training process.</p>
<p>Many loss functions are already implemented in <code>sklearn.metrics</code>. The XE is named <code>log_loss</code> and the squared loss is named <code>mean_sqquared_error</code>. Letâ€™s list all of them.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> metrics</span>
<span id="cb2-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>(metrics):</span>
<span id="cb2-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>): <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(m)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ConfusionMatrixDisplay
DetCurveDisplay
DistanceMetric
PrecisionRecallDisplay
PredictionErrorDisplay
RocCurveDisplay
accuracy_score
adjusted_mutual_info_score
adjusted_rand_score
auc
average_precision_score
balanced_accuracy_score
brier_score_loss
calinski_harabasz_score
check_scoring
class_likelihood_ratios
classification_report
cluster
cohen_kappa_score
completeness_score
confusion_matrix
consensus_score
coverage_error
d2_absolute_error_score
d2_pinball_score
d2_tweedie_score
davies_bouldin_score
dcg_score
det_curve
euclidean_distances
explained_variance_score
f1_score
fbeta_score
fowlkes_mallows_score
get_scorer
get_scorer_names
hamming_loss
hinge_loss
homogeneity_completeness_v_measure
homogeneity_score
jaccard_score
label_ranking_average_precision_score
label_ranking_loss
log_loss
make_scorer
matthews_corrcoef
max_error
mean_absolute_error
mean_absolute_percentage_error
mean_gamma_deviance
mean_pinball_loss
mean_poisson_deviance
mean_squared_error
mean_squared_log_error
mean_tweedie_deviance
median_absolute_error
multilabel_confusion_matrix
mutual_info_score
nan_euclidean_distances
ndcg_score
normalized_mutual_info_score
pair_confusion_matrix
pairwise
pairwise_distances
pairwise_distances_argmin
pairwise_distances_argmin_min
pairwise_distances_chunked
pairwise_kernels
precision_recall_curve
precision_recall_fscore_support
precision_score
r2_score
rand_score
recall_score
roc_auc_score
roc_curve
silhouette_samples
silhouette_score
top_k_accuracy_score
v_measure_score
zero_one_loss</code></pre>
</div>
</div>
<p>It comes in handy that <code>sklearn</code> has them already defined. Implementing each one of them is often not hard, e.g.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> log_loss(yt,yp):</span>
<span id="cb4-2">    yt[yt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>yp[yt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb4-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>np.log(y).mean()</span></code></pre></div>
</div>
<!-- ## Model selection / hyperparameter tuning 

Models may have many hyperparameters (learning rate, tree depth, neural network architectures etc). One can use k-fold cross validation to pick the one that optimises a certain metric prescribed by the user of these models. This is 


from sklearn.model_selection import RandomizedSearchCV, GridSearchCV
``` -->
</section>
<section id="analysis-of-errors" class="level2">
<h2 class="anchored" data-anchor-id="analysis-of-errors">Analysis of errors</h2>
<p>In practice, <img src="https://latex.codecogs.com/png.latex?D"> is unknown and we only observe the training error <img src="https://latex.codecogs.com/png.latex?L_S(h_S)"> and the validation error <img src="https://latex.codecogs.com/png.latex?L_V(h_S)">. Hence we decompose the generalisation error differently <img src="https://latex.codecogs.com/png.latex?%0AL_D(h_S)%20=%20%5BL_D(h_S)%20-%20L_V(h_S)%5D%20+%20%5BL_V(h_S)%20-%20L_S(h_S)%5D%20+%20L_S(h_S)%0A"> The first term is small when <img src="https://latex.codecogs.com/png.latex?%7CV%7C"> is moderately large by independence of <img src="https://latex.codecogs.com/png.latex?V"> and <img src="https://latex.codecogs.com/png.latex?S">. The second and third term are observalbe and several cases may arise.</p>
<ul>
<li>the gap is small and the training error is small. This is a happy scenario</li>
<li>the training error is large. To address this, we may consider
<ul>
<li>engarge the hypothesis class,</li>
<li>completely changing it,</li>
<li>find a better feature representation,</li>
<li>find a better optimiser<br>
</li>
</ul></li>
<li>training error is small but the gap is large. To address this, we may consider
<ul>
<li>add regularisation</li>
<li>get more training data</li>
<li>reduce the hypothesis class</li>
</ul></li>
</ul>
<p>It is benefiical to plot the learning curve during training. This amounts to visualise the training error and validation error on the same plot as time evolves (every X batches, every X epoch etc).</p>


</section>

 ]]></description>
  <category>python</category>
  <category>machine learning</category>
  <guid>https://xiaochuany.github.io/1principle/posts/deep-dive/uml-recap1.html</guid>
  <pubDate>Fri, 27 Oct 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Credit Risk Models Ep 2 machine learning methods for parameter estimation</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/deep-dive/crm2-ml.html</link>
  <description><![CDATA[ 





<blockquote class="blockquote">
<p>In a <a href="../../posts/deep-dive/crm1-fun.html">previous post</a>, weâ€™ve modelled the loss of a portfolio of <img src="https://latex.codecogs.com/png.latex?d"> instruments as follows <img src="https://latex.codecogs.com/png.latex?%0AL%20=%20%5Csum_%7Bi=1%7D%5Ed%20%5Cmu_i%20S_i%20I_i,%0A"> where <img src="https://latex.codecogs.com/png.latex?L"> represents the total loss, <img src="https://latex.codecogs.com/png.latex?%5Cmu_i"> is the exposure at default, <img src="https://latex.codecogs.com/png.latex?S_i"> is the loss given default, and <img src="https://latex.codecogs.com/png.latex?I_i"> is the event of default for the <img src="https://latex.codecogs.com/png.latex?i">-th instrument. To compute expected loss, VaR, and other relevant metrics in risk management, it is crucial to estimate these underlying parameters accurately. In this post, our focus is on estimating <img src="https://latex.codecogs.com/png.latex?p_i=%5Cmathbb%7BE%7D%5BI_i%5D">, which is formulated as a machine learning problem.</p>
</blockquote>
<section id="estimating-probaiblity-of-default-pd" class="level2">
<h2 class="anchored" data-anchor-id="estimating-probaiblity-of-default-pd">Estimating probaiblity of default (PD)</h2>
<p>Consider the real-world example of a bank approving loans for applicants based on their profiles. In this scenario, every applicant must fill out a comprehensive application form, including details such as their profession, age, amount of debts, monthly salary, and so on. The bank maintains records and, in retrospect, knows who has defaulted on their loans.</p>
<p>To formalize this process, each applicant corresponds to a vector in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ek">, known as the feature vector, which incorporates all the information from the form (possibly encoded for categorical values, e.g., converting â€˜professionâ€™ into dummy variables). The output we aim to predict is whether the applicant is in default (1) or not (0).</p>
<p>This constitutes a binary classification problem. With a substantial number of input-output pairs (features and default status) available, supervised learning algorithms can be employed to learn a relationship that can subsequently be used for predictions.</p>
<p>Many supervised learning algorithms for binary prediction actually output probabilities (specifically, the probability of the label being 1). This is suitable for our goal, as we precisely seek to estimate probabilities.</p>
<p>For illustration, letâ€™s consider a credit default risk dataset from this <a href="https://www.kaggle.com/competitions/home-credit-default-risk">Kaggle competition</a>. We set up the competition with <code>fastkaggle</code> module.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fastkaggle</span>
<span id="cb1-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ModuleNotFoundError</span>:</span>
<span id="cb1-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uq fastkaggle</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastkaggle <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">comp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'home-credit-default-risk'</span></span>
<span id="cb1-8">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> setup_comp(comp, install<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb1-9">path.ls()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(#10) [Path('home-credit-default-risk/application_train.csv'),Path('home-credit-default-risk/bureau_balance.csv'),Path('home-credit-default-risk/application_test.csv'),Path('home-credit-default-risk/sample_submission.csv'),Path('home-credit-default-risk/previous_application.csv'),Path('home-credit-default-risk/POS_CASH_balance.csv'),Path('home-credit-default-risk/HomeCredit_columns_description.csv'),Path('home-credit-default-risk/credit_card_balance.csv'),Path('home-credit-default-risk/installments_payments.csv'),Path('home-credit-default-risk/bureau.csv')]</code></pre>
</div>
</div>
<p>We primarily look into <code>application_train.csv</code>, which contains 308k rows and 121 input features. While there are numerous aspects to discuss regarding this dataset, for the sake of brevity, I will address two significant points here:</p>
<section id="missing-values" class="level3">
<h3 class="anchored" data-anchor-id="missing-values">Missing values</h3>
<p>There are many missing values in this dataset. To be more precise, 41 columns actually have half of their values missing.</p>
<p>This is a critical issue that needs to be addressed because many off-the-shelf machine learning models in scikit-learn, such as logistic regression, random forest, and support vector machines, cannot handle missing values represented as <code>np.nan</code>. There are two possible options to handle this:</p>
<ol type="1">
<li><p><strong>Impute the missing values</strong> before feeding the data into these models. Imputation can be done using â€œrule-basedâ€ methods such as scikit-learnâ€™s SimpleImputer or â€œlearning-basedâ€ methods such as scikit-learnâ€™s IterativeImputer.</p></li>
<li><p><strong>Use a different model that supports missing values natively.</strong> For instance, many gradient boosting implementations like HistGradientBoosting, XGBoost, LightGBM, and CatBoost handle missing values natively.</p></li>
</ol>
<p>For the sake of providing a quick benchmark, we have opted for the second option and are using scikit-learnâ€™s gradient boosting implementation, HistGradientBoostingClassifier. Explaining the detailed workings of gradient boosting is a vast topic that we might delve into in a future post.</p>
</section>
<section id="unbalanced-data" class="level3">
<h3 class="anchored" data-anchor-id="unbalanced-data">Unbalanced data</h3>
<p>Roughly 8% of the obligors goes into default in this dataset, making it unbalanced. From the perspective of risk management, it is important to predict defaults (label 1) accurately. Therefore, when it comes to evaluate model performance, accuracy is not an appropriate metric. Simply predicting non-default for all obligors would result in a correct prediction 92% of the time, but itâ€™s never correct for the defaults.</p>
<p>Applying a machine learning model directly to an unbalanced dataset can lead to sub-optimal results. Weâ€™ll demonstrate this point in the next section. A simple mitigation strategy is to sub-sample the majority class to match the size of the minority class, creating a balanced dataset. In this example, the minority class comprises roughly 25k rows, so we can train a model using this strategy as the balanced data is not too small to be useful. xx Obviously, the downside of this strategy is that we have thrown away lots of valuable data, but letâ€™s not worry about it at this stage of obtaining a quick benchmark.</p>
</section>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>First we feed the whole unbalanced dataset into HistGradientBoostingClassifier.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OneHotEncoder</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.compose <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_column_transformer, make_column_selector</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.pipeline <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_pipeline</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.ensemble <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HistGradientBoostingClassifier</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> classification_report</span>
<span id="cb3-9"></span>
<span id="cb3-10">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'application_train.csv'</span>)</span>
<span id="cb3-11">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TARGET'</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-12">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.TARGET</span>
<span id="cb3-13"></span>
<span id="cb3-14">X_tr, X_dev, y_tr, y_dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(X,y,test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1123</span>)</span>
<span id="cb3-15"></span>
<span id="cb3-16">ohe <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OneHotEncoder(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'if_binary'</span>)</span>
<span id="cb3-17">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HistGradientBoostingClassifier()</span>
<span id="cb3-18"></span>
<span id="cb3-19">ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_column_transformer(</span>
<span id="cb3-20">    (ohe, make_column_selector(dtype_exclude<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.number)),</span>
<span id="cb3-21">    remainder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passthrough'</span>,</span>
<span id="cb3-22">)</span>
<span id="cb3-23"></span>
<span id="cb3-24">pipe <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_pipeline(</span>
<span id="cb3-25">    ct,model</span>
<span id="cb3-26">)</span>
<span id="cb3-27"></span>
<span id="cb3-28">pipe.fit(X_tr,y_tr)</span>
<span id="cb3-29">y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipe.predict(X_dev)</span>
<span id="cb3-30"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(classification_report(y_pred,y_dev))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

           0       1.00      0.92      0.96     61330
           1       0.02      0.56      0.04       173

    accuracy                           0.92     61503
   macro avg       0.51      0.74      0.50     61503
weighted avg       1.00      0.92      0.96     61503
</code></pre>
</div>
</div>
<p>As we can see, the precision for class 1 is only 0.02, indicating that amongst all that are identified as defaults, only 2% of them are true defaults. Does this mean that the model we chose is rubbish? Not necessarily. Letâ€™s use the exact same model but now with a balanced dataset created using the sub-sampling strategy.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TARGET'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-2">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb5-3"></span>
<span id="cb5-4">df_balance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([df[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>mask].sample(m,random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),df[mask]], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-5"></span>
<span id="cb5-6">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_balance.TARGET</span>
<span id="cb5-7">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_balance.drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TARGET'</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-8"></span>
<span id="cb5-9">X_tr, X_dev, y_tr, y_dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(X,y,test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">112</span>)</span>
<span id="cb5-10"></span>
<span id="cb5-11">pipe.fit(X_tr,y_tr)</span>
<span id="cb5-12">y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipe.predict(X_dev)</span>
<span id="cb5-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(classification_report(y_pred,y_dev))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

           0       0.70      0.68      0.69      5050
           1       0.68      0.69      0.69      4880

    accuracy                           0.69      9930
   macro avg       0.69      0.69      0.69      9930
weighted avg       0.69      0.69      0.69      9930
</code></pre>
</div>
</div>
<p>Much better! All the metrics look roughly the same, hovering around 69%. While this is far from being deployable in the real world, as a baseline, itâ€™s far more reasonable than our previous attempt.</p>
<p>Weâ€™ll conclude the post here. To further enhance the overall performance, itâ€™s necessary to meticulously explore the features, engage in more feature engineering, employ clever methods of data imputation, and conduct thorough hyperparameter tuning. Give it a go!</p>


</section>

 ]]></description>
  <category>credit risk</category>
  <category>python</category>
  <category>machine learning</category>
  <guid>https://xiaochuany.github.io/1principle/posts/deep-dive/crm2-ml.html</guid>
  <pubDate>Fri, 20 Oct 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Credit Risk Models Ep 1 Fundamentals</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/deep-dive/crm1-fun.html</link>
  <description><![CDATA[ 





<blockquote class="blockquote">
<p>This is the first post in a series dedicated to credit risk models. The model discussed in this post is intentionally naive, as it relies on several unrealistic assumptions for the sake of simplicity and tractability. Despite its simplicity, this model serves as an excellent starting point for understanding the fundamental concepts of credit risk. It lays the foundation for more complex models that will be explored later in this series. The mathematical concepts introduced in this post are commonly found in any first-year probability textbook</p>
</blockquote>
<section id="pd-lgd-ead-approach" class="level2">
<h2 class="anchored" data-anchor-id="pd-lgd-ead-approach">PD-LGD-EAD approach</h2>
<p>Credit risk models are mathematical representations of the potential losses within a portfolio of financial instruments. Each instrument carries a probability of default, leading to either a complete loss or a partial loss. Modeling credit risk is crucial as it offers valuable insights to stakeholders, enabling them to take proactive measures to mitigate these losses. Consequently, it plays a pivotal role in the financial sector.</p>
<p>Letâ€™s introduce some notation. Consider a portfolio containing <img src="https://latex.codecogs.com/png.latex?d"> instruments. The event of default for the <img src="https://latex.codecogs.com/png.latex?i">-th instrument is denoted as <img src="https://latex.codecogs.com/png.latex?D_i">. Here, <img src="https://latex.codecogs.com/png.latex?%5Cmu_i"> represents the exposure at default (EAD) of the <img src="https://latex.codecogs.com/png.latex?i">-th instrument, and <img src="https://latex.codecogs.com/png.latex?S_i%20%5Cin%20%5B0,1%5D"> the loss given default (LGD) where <img src="https://latex.codecogs.com/png.latex?S"> signifies severity, indicating the actual loss relative to the exposure. We define <img src="https://latex.codecogs.com/png.latex?I_i%20:=%20I_%7BD_i%7D"> as the indicator of the event <img src="https://latex.codecogs.com/png.latex?D_i">, which follows a Bernoulli distribution with parameter <img src="https://latex.codecogs.com/png.latex?p_i%20:=%20%5Cmathbb%7BP%7D%5BD_i%5D">. The total loss of the portfolio is expressed as the sum: <span id="eq-loss"><img src="https://latex.codecogs.com/png.latex?%0AL%20=%20%5Csum_%7Bi=1%7D%5Ed%20%5Cmu_i%20S_i%20I_i%0A%5Ctag%7B1%7D"></span> From the perspective of risk managers, the values of <img src="https://latex.codecogs.com/png.latex?%5Cmu_i"> are known. However, the uncertainly lies in whether an instrument will default and the corresponding severity, making the total loss <img src="https://latex.codecogs.com/png.latex?L"> a random variable. Our interest lies in understanding the probability distribution of <img src="https://latex.codecogs.com/png.latex?L">.</p>
<p>In this post we make the following naive assumptions.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Assume that</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5C%7B(I_i,S_i)%5C%7D_%7Bi=1%7D%5Ed"> is a family of independent random vectors.</li>
<li><img src="https://latex.codecogs.com/png.latex?I_i"> is independent of <img src="https://latex.codecogs.com/png.latex?S_i"> for all <img src="https://latex.codecogs.com/png.latex?i%5Cin%20%5Bd%5D">.</li>
</ul>
</div>
</div>
<p>Under this assumption, it is clear that <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BE%7D%5BL%5D%20=%20%5Csum_%7Bi=1%7D%5Ed%20%5Cmu_i%20%5Cmathbb%7BE%7D%5BS_i%5D%20p_i%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BVar%7D%5BL%5D%20=%20%5Csum_%7Bi=1%7D%5Ed%20%5Cmu_i%5E2%20(%5Cmathbb%7BE%7D%5BS_i%5E2%5D%20p_i%20%20-%20%5Cmathbb%7BE%7D%5BS%5D%5E2%20p_i%5E2)%0A"> The expected loss (EL) is an important quantity in the <a href="https://www.eba.europa.eu/regulation-and-policy/single-rulebook/interactive-single-rulebook/1586">Basel III guidelines</a>.</p>
</section>
<section id="var-and-expected-shortfalls" class="level2">
<h2 class="anchored" data-anchor-id="var-and-expected-shortfalls">VaR and expected shortfalls</h2>
<p>In a stable economy, default events are infrequent, making credit risk modeling primarily focused on rare occurrences. Obtaining a precise measure of the credit risk of a portfolio is not achieved by merely calculating the average; instead, itâ€™s crucial to comprehend the quantiles. In the realm of credit risk, these quantiles are referred to as the Value at Risk (VaR).<br>
<img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BVaR%7D_%5Calpha(L)%20=%20%5Cinf%5C%7Bt%5Cin%5Cmathbb%7BR%7D:%20%5Cmathbb%7BP%7D%5BL%5Cge%20t%5D%5Cle%20%5Calpha%20%5C%7D.%0A"> Another commonly utilized metric is the Expected Shortfall, which represents the conditional expectation of the loss <img src="https://latex.codecogs.com/png.latex?L"> given that <img src="https://latex.codecogs.com/png.latex?L"> exceeds the VaR <img src="https://latex.codecogs.com/png.latex?%0AE_%5Calpha(L)%20=%20%5Cmathbb%7BE%7D%5BL%7CL%5Cge%5Cmathrm%7BVaR%7D_%5Calpha%5D.%0A"> Clearly <img src="https://latex.codecogs.com/png.latex?E_%5Calpha(L)%5Cge%20%5Cmathrm%7BVaR%7D_%5Calpha(L)">.</p>
<p>Itâ€™s crucial to acknowledge that the joint distribution of <img src="https://latex.codecogs.com/png.latex?(I_i,%20S_i)"> is <strong>unknown</strong>. To compute VaR and expected shortfalls, risk analysts must undertake at least three tasks:</p>
<ol type="1">
<li><strong>Model Calibration:</strong> This involves determining the modelâ€™s parameters using available data.</li>
<li><strong>Distribution Computation:</strong> Compute the distribution of <img src="https://latex.codecogs.com/png.latex?L"> either analytically or through Monte Carlo simulation, based on the calibrated parameters.</li>
<li><strong>Metrics Computation:</strong> Utilize the obtained distribution to compute VaR, shortfall, or other relevant metrics either analytically or numerically.</li>
</ol>
<p>The calibration process demands substantial effort and is specific to the chosen model. We will delve into this topic in a future post. For the remainder of this discussion, letâ€™s assume that we have already established a set of parameters and focus on the last two steps.</p>
<p>Itâ€™s important to emphasize that deriving the exact distribution of <img src="https://latex.codecogs.com/png.latex?L"> can be tedious, if not infeasible. In practice, risk analysts resort to simulations and numerical computations to determine VaR and shortfalls. This pragmatic approach is the one we adopt here.</p>
</section>
<section id="monte-carlo-simulation-for-estimating-var-and-shortfalls" class="level2">
<h2 class="anchored" data-anchor-id="monte-carlo-simulation-for-estimating-var-and-shortfalls">Monte Carlo simulation for estimating VaR and shortfalls</h2>
<p><strong>Step 1</strong></p>
<p>We first specify the parameters <img src="https://latex.codecogs.com/png.latex?p_i,%20%5Cmu_i"> and parameters for the distribution of <img src="https://latex.codecogs.com/png.latex?S_i">. These parameters are generated at random with arbitrary choice of distributions, following<br>
<span class="citation" data-cites="bolder2018credit">Bolder (2018)</span></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set random seed for reproducibility</span></span>
<span id="cb1-6">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1123</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of instruments</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the probability of default for d instruments, low 0.1 high 7 per cent</span></span>
<span id="cb1-11">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.chisquare(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(d,))</span>
<span id="cb1-12">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, x)</span>
<span id="cb1-13">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, x)</span>
<span id="cb1-14">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> </span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set exposures parameters normalised to have total exposure 1000</span></span>
<span id="cb1-17">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.weibull(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,(d,))</span>
<span id="cb1-18">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>y.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set serverity parameters</span></span>
<span id="cb1-21">a,b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span></span></code></pre></div>
</div>
<p><strong>Step 2</strong></p>
<p>Next we simulate <img src="https://latex.codecogs.com/png.latex?L"> for a large number of times accoding to Equation&nbsp;1. We sort the samples in the end, useful for computing the empirical distributions later on.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50_000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of repetitions</span></span>
<span id="cb2-2">S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.beta(a, b, (m,d))</span>
<span id="cb2-3">I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.uniform(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(m,d)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> p</span>
<span id="cb2-4">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> mu</span>
<span id="cb2-5">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sort(L)</span></code></pre></div>
</div>
<p><strong>Step 3</strong></p>
<p>We plot the histogram and empirical distribution, then estimate VaR and expected shortfalls.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate VaR </span></span>
<span id="cb3-2">pers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">95</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">99.9</span>])</span>
<span id="cb3-3">alphas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> pers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb3-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.percentile(L, pers)</span>
<span id="cb3-5"></span>
<span id="cb3-6">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-7">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].hist(L, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Histogram of Loss'</span>)</span>
<span id="cb3-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>): </span>
<span id="cb3-9">  axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axvline(var,linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dashed'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g.uniform(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,)),label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'VaR</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>alphas[i]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb3-10">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].legend()</span>
<span id="cb3-11"></span>
<span id="cb3-12">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(L,np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(L),endpoint<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'empirical distribution'</span>)</span>
<span id="cb3-13">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].legend()</span>
<span id="cb3-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>: </span>
<span id="cb3-15">  axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].axvline(var,linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dashed'</span>)</span>
<span id="cb3-16">plt.show()</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate shortfalls</span></span>
<span id="cb3-19">shortfalls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>))</span>
<span id="cb3-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>):</span>
<span id="cb3-21">  shortfalls[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L[L<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>var].mean()</span>
<span id="cb3-22"></span>
<span id="cb3-23">pd.set_option(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'display.precision'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb3-24">pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alphas'</span>: alphas, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'VaR'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Shortfalls'</span>: shortfalls}).set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alphas'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://xiaochuany.github.io/1principle/posts/deep-dive/crm1-fun_files/figure-html/cell-4-output-1.png" width="592" height="411" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VaR</th>
<th data-quarto-table-cell-role="th">Shortfalls</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">alphas</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.050</td>
<td>12.6668</td>
<td>16.2741</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.010</td>
<td>18.6163</td>
<td>21.4599</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.001</td>
<td>25.4548</td>
<td>28.1533</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Weâ€™ve completed tasks 2 and 3! Next time, weâ€™ll delve into methods of parameter estimation, still within the naive setting. This will bring us full circle and complete the lifecycle of a single model.</p>
</section>
<section id="references" class="level2">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-bolder2018credit" class="csl-entry">
Bolder, David Jamieson. 2018. <em>Credit-Risk Modelling</em>. Springer.
</div>
</div></section></div> ]]></description>
  <category>credit risk</category>
  <category>applied probability</category>
  <category>python</category>
  <guid>https://xiaochuany.github.io/1principle/posts/deep-dive/crm1-fun.html</guid>
  <pubDate>Sun, 15 Oct 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Understanding Machine Learning: a series of 20 videos</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/deep-dive/uml.html</link>
  <description><![CDATA[ 





<blockquote class="blockquote">
<p>From Oct 2022 to Feb 2023, I have created a series of 20 videos (in Chinese) on machine learning theory and algorithms on bilibili.com, closely following the excellent textbook written by Shalev-Shwartz and Ben-David, which is freely available on the <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html">authorsâ€™ webpage</a>.</p>
</blockquote>
<p><a href="https://www.youtube.com/playlist?list=PLRUGJ8qKWnox5Jn2URD_0OQwvnl_uv3IU">Playlist in my YouTube channel</a></p>
<p>Topics covered include</p>
<ul>
<li>Probably Approximately Correct (PAC) learning model</li>
<li>VC dimension</li>
<li>no free lunch theorem</li>
<li>linear predictors: logistic regression, linear regression, perceptron</li>
<li>convex learning problems</li>
<li>regularisation</li>
<li>stochastic gradient descent</li>
<li>support vector machine</li>
<li>kernel methods</li>
<li>decision trees</li>
<li>boosting: AdaBoost</li>
<li>clustering: k-means, spectral clustering, linkage-based clustering</li>
<li>dimenionality reduction: PCA, compressed sensing</li>
<li>generative models: naive Bayes, LDA, EM algorithms</li>
</ul>
<p><img src="https://xiaochuany.github.io/1principle/posts/assets/uml_cover.jpg" class="img-fluid"></p>



 ]]></description>
  <category>machine learning</category>
  <guid>https://xiaochuany.github.io/1principle/posts/deep-dive/uml.html</guid>
  <pubDate>Sat, 14 Oct 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Secret â€˜SAWSâ€™ of deep learning, feature backprop</title>
  <dc:creator>Xiaochuan Yang</dc:creator>
  <link>https://xiaochuany.github.io/1principle/posts/deep-dive/saws.html</link>
  <description><![CDATA[ 





<blockquote class="blockquote">
<p>My colleague Simon Shaw came up with the memorable notation SAWS for the key recursion step in backprop in a Year 2 module on deep learning. I found this a perfect example of â€œgood notation helps memorisationâ€ which hopefully reinforces understanding. In this post, I will explain how we get to this recursion and end the post with a python implementation.</p>
</blockquote>
<section id="multi-layer-perceptron" class="level2">
<h2 class="anchored" data-anchor-id="multi-layer-perceptron">Multi-Layer Perceptron</h2>
<p>Everyone knows that a neural network is a universal function approximator that can be used to learn complex relationships between inputs and outputs. It is a learning machine that mimics biological neural networks in the human brain. Mathematically, given an input <img src="https://latex.codecogs.com/png.latex?x%5Cin%5Cmathbb%7BR%7D%5E%7Bn_x%7D">, a neural nerwork computes an ouput <img src="https://latex.codecogs.com/png.latex?%5Chat%20y%5Cin%5Cmathbb%7BR%7D%5E%7Bn_y%7D"> as follows, <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0Aa%5E%7B%5B1%5D%7D%20&amp;=%20%5Csigma(W%5E%7B%5B1%5D%5Ctop%7D%20x%20+%20b%5E%7B%5B1%5D%7D)%20%5C%5C%0Aa%5E%7B%5B2%5D%7D%20&amp;=%20%5Csigma(W%5E%7B%5B2%5D%5Ctop%7D%20a%5E%7B%5B1%5D%7D%20+%20b%5E%7B%5B2%5D%7D)%20%5C%5C%0A&amp;%5Cvdots%20%5C%5C%0Aa%5E%7B%5BL%5D%7D%20&amp;=%20%5Csigma(W%5E%7B%5BL%5D%5Ctop%7D%20a%5E%7B%5BL-1%5D%7D%20+%20b%5E%7B%5BL%5D%7D)%20%5C%5C%0A%5Chat%20y%20&amp;=%20%5Csigma(W%5E%7B%5BL+1%5D%5Ctop%7D%20a%5E%7B%5BL%5D%7D%20+%20b%5E%7B%5BL+1%5D%7D)%0A%5Cend%7Balign*%7D"></p>
<p>Here <img src="https://latex.codecogs.com/png.latex?%5Csigma:%5Cmathbb%7BR%7D%5Cto%5Cmathbb%7BR%7D"> is any nonlinear differentiable function (or sufficiently close to be such), <img src="https://latex.codecogs.com/png.latex?L"> is the number of hidden layers, <img src="https://latex.codecogs.com/png.latex?W"> and <img src="https://latex.codecogs.com/png.latex?b"> are weight matrices and bias vectors. We use <img src="https://latex.codecogs.com/png.latex?n_l"> to denote the number of hidden nodes in the <img src="https://latex.codecogs.com/png.latex?l">-th layer. The pre-activation vector at layer <img src="https://latex.codecogs.com/png.latex?l"> is denoted by <img src="https://latex.codecogs.com/png.latex?z%5E%7B%5Bl%5D%7D">.</p>
<p>From the definition we see that <img src="https://latex.codecogs.com/png.latex?%5Chat%20y"> is not only a function of <img src="https://latex.codecogs.com/png.latex?x">, but also a function of <img src="https://latex.codecogs.com/png.latex?z%5E%7B%5B1%5D%7D,%20z%5E%7B%5B2%5D%7D"> and so forth using sub-networks. This may seem like stating the obvious, but itâ€™s a useful fact to keep in mind when we derive the algorithm for training these networks.</p>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>How to train a neural network to make good predictions? Well, we first need to specify a computable objective. To achieve this we introduce a loss function that measures how good or bad a predictor is compared to the ground truth. This is called supervised learning. A commonly used loss is the squared loss <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20%5Cell(u,v)%20=%20%20%5Cfrac%7B1%7D%7B2%7D%20%5C%7Cu-v%5C%7C%5E2%0A%5Cend%7Balign*%7D"> where <img src="https://latex.codecogs.com/png.latex?%5C%7C%5Ccdot%5C%7C"> is the Euclidean norm. Then our goal is to minimize <img src="https://latex.codecogs.com/png.latex?J=%5Cell(y,%5Chat%20y)">.</p>
<p>A general-purpose optimization method is gradient descent. In every iteration step, this method updates the parameters (i.e.&nbsp;weights and biases) by moving along the opposite of the gradient of the loss with respect to the parameters. Due to the characterization of the gradient of a function as being the direction along which the function increases the most (infinitesimally speaking), this method is heuristically justified for minimizing an objective function when the step size (aka learning rate) is not too large.</p>
<p>A crucial point is that we need to compute all the partial derivatives for every gradient descent step! Mathematically this is tedious but not hard at all. Everyone knows that to differentiate a composition of functions, the chain rule is our best friend. Sure, we have multiple compositions, but it does not produce any conceptual complications because we can just apply the chain rule multiple times.</p>
<p>Take weight matrix <img src="https://latex.codecogs.com/png.latex?W%5E%7B%5B1%5D%7D"> as an example. Any small nudge on its value would result in changes in <img src="https://latex.codecogs.com/png.latex?z%5E%7B%5B1%5D%7D">, and once we have the value of <img src="https://latex.codecogs.com/png.latex?z%5E%7B%5B1%5D%7D">, we feed it into the sub-network made of layers <img src="https://latex.codecogs.com/png.latex?1"> to <img src="https://latex.codecogs.com/png.latex?L+1"> and get the output. Hence <img src="https://latex.codecogs.com/png.latex?J=g(z%5E%7B%5B1%5D%7D)"> for some <img src="https://latex.codecogs.com/png.latex?g">. By the chain rule,<br>
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20W%5E%7B%5B1%5D%7D%7D%20=%20%20%0A%20%20%20%20%5Csum_i%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5B1%5D%7D_i%7D%20%5Cfrac%7B%5Cpartial%20z%5E%7B%5B1%5D%7D_i%7D%7B%5Cpartial%20W%5E%7B%5B1%5D%7D%7D.%0A%5Cend%7Balign*%7D"></p>
<p>The second gradient in the summand is the rather simple because <img src="https://latex.codecogs.com/png.latex?z%5E%7B%5B1%5D%7D"> is a linear function of <img src="https://latex.codecogs.com/png.latex?W%5E%7B%5B1%5D%7D">. However, the first gradient is not explicit because the function <img src="https://latex.codecogs.com/png.latex?g"> is cumbersome as a composition of compositions of compositions â€¦ What we can do is to apply chain rule again, then <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5B1%5D%7D%7D%0A%20%20%20%20=%20%5Csum_i%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5B2%5D%7D_i%7D%20%5Cfrac%7B%5Cpartial%20z%5E%7B%5B2%5D%7D_i%7D%7B%5Cpartial%20z%5E%7B%5B1%5D%7D%7D%0A%5Cend%7Balign*%7D"></p>
<p>Recalling <img src="https://latex.codecogs.com/png.latex?z%5E%7B%5B2%5D%7D%20=%20W%5E%7B%5B2%5D%5Ctop%7D%20%5Csigma(z%5E%7B%5B1%5D%7D)%20+%20b%5E%7B%5B2%5D%7D">, the second gradient is easy to calculate. Hence, the gradient of <img src="https://latex.codecogs.com/png.latex?J"> with respect to the first layer pre-activation is a linear combination of the gradient with respect to the second layer pre-activation. Applying the chain rule recursively in the forward direction all the way to the output layer, we can express <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5B1%5D%7D%7D"> as a multiple sum over <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5BL+1%5D%7D%7D"> times multiple products of gradients of consecutive pre-activations.</p>
Following the same recipe, we can compute the gradients with respect to weights and biases of all the layers. In summary, we would need for all <img src="https://latex.codecogs.com/png.latex?l=1,%5Cldots,L+1">:
<p>and chain them together using multiple sums and products. This seems like a lot of work, even for a computer!</p>
<p>Here comes an important observation. There are lots of redundant computations if we use the recipe just described to compute an explicit form for all the gradients at every layer.</p>
<p>The big idea is to take advantage of the recursive relations between gradients with respect to pre-activations of consecutive layers. To be more precise, letâ€™s rewrite both equations at a general layer (we also include an equation for the biases).</p>
<p><span id="eq-gradW"><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20W%5E%7B%5Bl%5D%7D%7D%20=%20%5Csum_i%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D_i%7D%20%5Cfrac%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D_i%7D%7B%5Cpartial%20W%5E%7B%5Bl%5D%7D%7D.%0A%5Ctag%7B1%7D"></span></p>
<p><span id="eq-gradb"><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20b%5E%7B%5Bl%5D%7D%7D%20=%20%5Csum_i%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D_i%7D%20%5Cfrac%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D_i%7D%7B%5Cpartial%20b%5E%7B%5Bl%5D%7D%7D%0A%5Ctag%7B2%7D"></span></p>
<p><span id="eq-recursion"><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D%7D%20=%20%5Csum_i%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5Bl+1%5D%7D_i%7D%20%5Cfrac%7B%5Cpartial%20z%5E%7B%5Bl+1%5D%7D_i%7D%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D%7D%0A%5Ctag%7B3%7D"></span></p>
<p>Let <img src="https://latex.codecogs.com/png.latex?S%5E%7B%5Bl%5D%7D%20=%20%5Cfrac%7B%5Cpartial%20J%7D%7B%5Cpartial%20z%5E%7B%5Bl%5D%7D%7D">. We use equations Equation&nbsp;1 and Equation&nbsp;2, along with <img src="https://latex.codecogs.com/png.latex?S%5E%7B%5BL+1%5D%7D"> (easy to compute), to find the required gradients for updating <img src="https://latex.codecogs.com/png.latex?W%5E%7B%5BL+1%5D%7D"> and <img src="https://latex.codecogs.com/png.latex?b%5E%7B%5BL+1%5D%7D">. Then we use equation Equation&nbsp;3 to find <img src="https://latex.codecogs.com/png.latex?S%5E%7B%5BL%5D%7D">, which can be plugged back into equations Equation&nbsp;1 and Equation&nbsp;2 to get the required gradient for updating <img src="https://latex.codecogs.com/png.latex?W%5E%7B%5BL%5D%7D"> and <img src="https://latex.codecogs.com/png.latex?b%5E%7B%5BL%5D%7D">, and so on.</p>
<p>What we just described is the famous backpropagation. The advantage of this approach is that we compute each basic computation (itemized above) only once for each gradient descent iteration.</p>
<p>From layer to layer, the computation is done sequentially, because output of <img src="https://latex.codecogs.com/png.latex?l+1">-th layer is requiredd as the input for computing gradients of <img src="https://latex.codecogs.com/png.latex?l">-th layer. For each fixed <img src="https://latex.codecogs.com/png.latex?l">, however, it is better to parallelise the computation and write Equation&nbsp;1 -Equation&nbsp;3 in matrix forms. Here is how we do it:</p>
<section id="squared-loss" class="level3">
<h3 class="anchored" data-anchor-id="squared-loss">Squared loss</h3>
<p>Set <img src="https://latex.codecogs.com/png.latex?A%5E%7B%5Bl%5D%7D=%5Cmathrm%7Bdiag%7D(%5Csigma'(z%5E%7B%5Bl%5D%7D))"> and <img src="https://latex.codecogs.com/png.latex?e%20=%20y%20-%20%5Chat%20y">. It is easy to see that <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20S%5E%7B%5BL+1%5D%7D%20=%20-%20A%5E%7B%5BL+1%5D%7D%20e%0A%5Cend%7Balign*%7D"> Equation Equation&nbsp;3 can be written in matrix form as well <span id="eq-saws"><img src="https://latex.codecogs.com/png.latex?%0AS%5E%7B%5Bl%5D%7D%20=%20A%5E%7B%5Bl%5D%7D%20W%5E%7B%5Bl+1%5D%7D%20S%5E%7B%5Bl+1%5D%7D%0A%5Ctag%7B4%7D"></span> Now the gradients <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20dW%5E%7B%5Bl%5D%7D%20&amp;=%20a%5E%7B%5Bl-1%5D%7D%20S%5E%7B%5Bl%5D%5Ctop%7D%20%5C%5C%0A%20%20%20%20db%5E%7B%5Bl%5D%7D%20&amp;=%20S%5E%7B%5Bl%5D%7D%0A%5Cend%7Balign*%7D"></p>
<p>Equation&nbsp;4 is what I meant by secret â€œSAWSâ€ of deep learning!</p>
</section>
<section id="cross-entropy-loss" class="level3">
<h3 class="anchored" data-anchor-id="cross-entropy-loss">Cross entropy loss</h3>
<p>The XE loss is defined for two probability mass functions as follows <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20%5Cell(u,v)%20=%20-%5Csum_k%20u_k%5Clog%20v_k.%0A%5Cend%7Balign*%7D"> It is particularly well suited for multiclass classification problem. To ensure that <img src="https://latex.codecogs.com/png.latex?%5Chat%20y"> is a probability mass function. We use the softmax activation function at the output layer <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20%5Cmathrm%7Bsoftmax%7D(x)%20=%20%20%5Cfrac%7Be%5E%7Bx%7D%7D%7B%5Csum_i%20e%5E%7Bx_i%7D%7D%0A%5Cend%7Balign*%7D"> All we have to do is to change the computation of <img src="https://latex.codecogs.com/png.latex?S%5E%7B%5BL+1%5D%7D">, namely the gradient of the XE loss with respect to the output layer pre-activation, then back propagate using the last three equations in the squared loss case. A routine application of chain rule yields that <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%20%20S%5E%7B%5BL+1%5D%7D%20=%20-%20e%0A%5Cend%7Balign*%7D"> where <img src="https://latex.codecogs.com/png.latex?e"> was defined earlier in the squared loss case.</p>
</section>
</section>
<section id="python-implementation" class="level2">
<h2 class="anchored" data-anchor-id="python-implementation">Python Implementation</h2>
<p>Here is a python implementation of the training with min-batch SGD, 1 hidden layer, sigmoid activation in the hidden and output layers, and squared loss.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sig(x):</span>
<span id="cb1-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1123</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8">d,m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-9">d_out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb1-10">d_hid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb1-11">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb1-12">n_epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-13">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb1-14"></span>
<span id="cb1-15">X_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(d,m))</span>
<span id="cb1-16">Y_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.uniform(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(d_out,m))</span>
<span id="cb1-17"></span>
<span id="cb1-18">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(d,d_hid))</span>
<span id="cb1-19">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(d_hid,d_out))</span>
<span id="cb1-20">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(d_hid,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb1-21">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(d_out,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb1-22"></span>
<span id="cb1-23">errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[]</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> epoch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_epoch):</span>
<span id="cb1-26">    error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># permute the data</span></span>
<span id="cb1-28">    perm_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.permutation(m)</span>
<span id="cb1-29">    X_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_train[:,perm_idx]</span>
<span id="cb1-30">    Y_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y_train[:,perm_idx]</span>
<span id="cb1-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> bat <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>batch_size):</span>
<span id="cb1-32">        x_batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_train[:,bat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>batch_size:(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>bat)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>batch_size]</span>
<span id="cb1-33">        y_batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y_train[:,bat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>batch_size:(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>bat)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>batch_size]</span>
<span id="cb1-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb1-35">        z1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.matmul(W1.T,x_batch) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb1-36">        a1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sig(z1)</span>
<span id="cb1-37">        z2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.matmul(W2.T,a1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb1-38">        a2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sig(z2)</span>
<span id="cb1-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb1-40">        e <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> a2</span>
<span id="cb1-41">        A2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sig(z2)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sig(z2))</span>
<span id="cb1-42">        S2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> A2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>e</span>
<span id="cb1-43">        A1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sig(z1)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sig(z1))</span>
<span id="cb1-44">        S1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.matmul(W2,S2)</span>
<span id="cb1-45">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gradient descent</span></span>
<span id="cb1-46">        dW2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.matmul(a1,S2.T)</span>
<span id="cb1-47">        db2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(S2, axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-48">        dW1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.matmul(x_batch,S1.T)</span>
<span id="cb1-49">        db1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(S1, axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-50">        W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dW2</span>
<span id="cb1-51">        b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> db2</span>
<span id="cb1-52">        W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dW1</span>
<span id="cb1-53">        b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> db1</span>
<span id="cb1-54">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute the error </span></span>
<span id="cb1-55">        error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>e)</span>
<span id="cb1-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># report error of the current epoch</span></span>
<span id="cb1-57">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch:"</span>, epoch, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SE:"</span>, error)</span>
<span id="cb1-58">    errors.append(error)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 0 SE: 1084.095701311093
Epoch: 1 SE: 931.4561396806077</code></pre>
</div>
</div>
<p><strong>Exercise</strong>: implement the training with XE loss and more hidden layers.</p>


</section>

 ]]></description>
  <category>deep learning</category>
  <category>python</category>
  <guid>https://xiaochuany.github.io/1principle/posts/deep-dive/saws.html</guid>
  <pubDate>Tue, 10 Oct 2023 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
